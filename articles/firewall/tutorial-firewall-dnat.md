---
title: 使用 Azure 入口網站以 Azure 防火牆 DNAT 篩選輸入流量
description: 在本教學課程中，您將了解如何使用 Azure 入口網站部署及設定 Azure 防火牆 DNAT。
services: firewall
author: vhorne
ms.service: firewall
ms.topic: tutorial
ms.date: 9/27/2018
ms.author: victorh
ms.custom: mvc
ms.openlocfilehash: 894389ec07fb8e371a269f895473fe82985de7c3
ms.sourcegitcommit: b7e5bbbabc21df9fe93b4c18cc825920a0ab6fab
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/27/2018
ms.locfileid: "47405966"
---
# <a name="tutorial-filter-inbound-traffic-with-azure-firewall-dnat-using-the-azure-portal"></a>教學課程：使用 Azure 入口網站以 Azure 防火牆 DNAT 篩選輸入流量

您可以設定 Azure 防火牆目的地網路位址轉譯 (DNAT)，將輸入流量轉譯及篩選至您的子網路。 當您設定 DNAT 時，NAT 規則集合動作是設為**目的地網路位址轉譯 (DNAT)**。 接著，NAT 規則集合中的每個規則均可用來將防火牆公用 IP 和連接埠轉譯為私人 IP 和連接埠。 DNAT 規則會隱含地新增對應的網路規則，以允許已轉譯的流量。 若要覆寫這個行為，您可以明確地使用符合已轉譯流量的拒絕規則來新增網路規則集合。 若要深入了解 Azure 防火牆規則處理邏輯，請參閱 [Azure 防火牆規則處理邏輯](rule-processing.md)。

> [!NOTE]
> DNAT 在連接埠 80 與 22 上無法運作。 我們會在不久的將來修正此問題。 同時，請使用任何其他連接埠作為 NAT 規則中的目的地連接埠。 連接埠 80 或 22 仍可用來當作轉譯連接埠。 例如，您可以將公用 IP:81 對應到私人 IP:80。

在本教學課程中，您了解如何：

> [!div class="checklist"]
> * 設定測試網路環境
> * 部署防火牆
> * 建立預設路由
> * 設定 DNAT 規則
> * 測試防火牆

如果您沒有 Azure 訂用帳戶，請在開始前建立 [免費帳戶](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) 。

針對本教學課程，您會建立兩個對等互連 Vnet：
- **VN-Hub** - 防火牆位於此 VNet 中。
- **VN-Spoke** - 工作負載伺服器位於此 VNet 中。

## <a name="create-a-resource-group"></a>建立資源群組
1. 在 [http://portal.azure.com](http://portal.azure.com) 登入 Azure 入口網站。
1. 在 Azure 入口網站首頁上，按一下 [資源群組]，然後按一下 [新增]。
2. 在 [資源群組名稱] 中，輸入 **RG-DNAT-Test**。
3. 在 [訂用帳戶] 中，選取您的訂用帳戶。
4. 在 [資源群組位置] 中，選取位置。 您所建立的所有後續資源都必須位在相同的位置。
5. 按一下頁面底部的 [新增] 。

## <a name="set-up-the-network-environment"></a>設定網路環境
首先建立 Vnet，然後將其對等互連。

### <a name="create-the-hub-vnet"></a>建立中樞 VNet
1. 從 Azure 入口網站首頁，按一下 [所有服務]。
2. 在 [網路] 底下，按一下 [虛擬網路]。
3. 按一下 [新增] 。
4. 在 [名稱] 中，輸入 **VN-Hub**。
5. 在 [位址空間] 中，鍵入 **10.0.0.0/16**。
7. 在 [訂用帳戶] 中，選取您的訂用帳戶。
8. 在 [資源群組] 中，選取 [使用現有的]，然後選取 [RG-DNAT-Test]。
9. 在 [位置] 中，選取您先前使用的相同位置。
10. 在 [子網路] 底下的 [名稱] 中鍵入 **AzureFirewallSubnet**。

     防火牆會在此子網路中，且子網路名稱「必須」是 AzureFirewallSubnet。
     > [!NOTE]
     > AzureFirewallSubnet 子網路的大小下限是 /25。
11. 在 [位址範圍] 中，鍵入 **10.0.1.0/24**。
12. 使用其他預設設定，然後按一下 [建立]。

### <a name="create-a-spoke-vnet"></a>建立輪輻 VNet

1. 從 Azure 入口網站首頁，按一下 [所有服務]。
2. 在 [網路] 底下，按一下 [虛擬網路]。
3. 按一下 [新增] 。
4. 在 [名稱] 中，輸入 **VN-Spoke**。
5. 在 [位址空間] 中，輸入 **192.168.0.0/16**。
7. 在 [訂用帳戶] 中，選取您的訂用帳戶。
8. 在 [資源群組] 中，選取 [使用現有的]，然後選取 [RG-DNAT-Test]。
9. 在 [位置] 中，選取您先前使用的相同位置。
10. 在 [子網路] 底下的 [名稱] 中，輸入 **SN-Workload**。

    伺服器會在此子網路中。
1. 在 [位址範圍] 中，輸入 **192.168.1.0/24**。
2. 使用其他預設設定，然後按一下 [建立]。

### <a name="peer-the-vnets"></a>將 VNet 對等互連

現在對等互連兩個 VNet。

#### <a name="hub-to-spoke"></a>中樞至輪輻

1. 按一下 [VN-Hub] 虛擬網路。
2. 在 [設定] 下方，按一下 [對等互連]。
3. 按一下 [新增] 。
4. 針對名稱輸入 **Peer-HubSpoke**。
5. 針對虛擬網路選取 [VN-Spoke]。
7. 按一下 [確定]。

#### <a name="spoke-to-hub"></a>輪輻至中樞

1. 按一下 [VN-Spoke] 虛擬網路。
2. 在 [設定] 下方，按一下 [對等互連]。
3. 按一下 [新增] 。
4. 針對名稱輸入 **Peer-SpokeHub**。
5. 針對虛擬網路選取 [VN-Hub]。
6. 按一下 [允許轉送的流量]。
7. 按一下 [確定]。

## <a name="create-a-virtual-machine"></a>建立虛擬機器

建立工作負載虛擬機器，並將它放在 **SN-Workload** 子網路中。

1. 從 Azure 入口網站首頁，按一下 [所有服務]。
2. 在 [計算] 底下，按一下 [虛擬機器]。
3. 按一下 [新增]，然後按一下 [Windows Server]、按一下 [Windows Server 2016 Datacenter]，然後按一下 [建立]。

**基本概念**

1. 在 [名稱] 中，輸入 **Srv-Workload**。
5. 鍵入使用者名稱和密碼。
6. 在 [訂用帳戶] 中，選取您的訂用帳戶。
7. 在 [資源群組] 中，按一下 [使用現有的]，然後選取 [RG-DNAT-Test]。
8. 在 [位置] 中，選取您先前使用的相同位置。
9. 按一下 [確定]。

**大小**

1. 針對執行 Windows Server 的測試虛擬機器選擇適當的大小。 例如，**B2ms** (8 GB 的 RAM，16 GB 的儲存空間)。
2. 按一下 [選取] 。

**設定**

1. 在 [網路] 底下的 [虛擬網路] 中選取 [VN-Spoke]。
2. 在 [子網路] 中，選取 [SN-Workload]。
3. 按一下 [公用 IP 位址]，然後按一下 [無]。
4. 在 [選取公用輸入連接埠] 中，選取 [沒有公用輸入連接埠]。 
2. 保留其他的預設設定，然後按一下 [確定]。

**總結**

檢閱摘要，然後按一下 [建立]。 這需要幾分鐘才能完成。

部署完成之後，請記下虛擬機器的私人 IP 位址。 稍後當您設定防火牆時將會用到該位址。 按一下虛擬機器名稱，然後在 [設定] 底下按一下 [網路]，以尋找私人 IP 位址。


## <a name="deploy-the-firewall"></a>部署防火牆

1. 從入口網站首頁中，按一下 [建立資源]。
2. 按一下 [網路]，並在 [精選] 後按一下 [查看全部]。
3. 按一下 [防火牆]，然後按一下 [建立]。 
4. 在 [建立防火牆] 頁面上，使用下表來設定防火牆：
   
   |設定  |值  |
   |---------|---------|
   |名稱     |FW-DNAT-test|
   |訂用帳戶     |\<您的訂用帳戶\>|
   |資源群組     |**使用現有的**：RG-DNAT-Test |
   |位置     |選取您先前使用的相同位置|
   |選擇虛擬網路     |**使用現有的**：VN-Hub|
   |公用 IP 位址     |**建立新項目**。 公用 IP 位址必須是標準 SKU 類型。|

2. 按一下 [檢閱 + 建立]。
3. 檢閱摘要，然後按一下 [建立] 來建立防火牆。

   這需要幾分鐘才能部署。
4. 部署完成之後，請前往 **RG-DNAT-Test** 資源群組，然後按一下 [FW-DNAT-test] 防火牆。
6. 請記下私人 IP 位址。 稍後當您建立預設路由時將使用到它。


## <a name="create-a-default-route"></a>建立預設路由

在 **SN-Workload** 子網路中，您要設定通過防火牆的輸出預設路由。

1. 從 Azure 入口網站首頁，按一下 [所有服務]。
2. 在 [網路] 底下，按一下 [路由表]。
3. 按一下 [新增] 。
4. 在 [名稱] 中，輸入 **RT-FWroute**。
5. 在 [訂用帳戶] 中，選取您的訂用帳戶。
6. 在 [資源群組] 中，選取 [使用現有的]，然後選取 [RG-DNAT-Test]。
7. 在 [位置] 中，選取您先前使用的相同位置。
8. 按一下頁面底部的 [新增] 。
9. 按一下 [重新整理]，然後按一下 **RT-FWroute** 路由表。
10. 按一下 [子網路]，然後按一下 [關聯]。
11. 按一下 [虛擬網路]，然後選取 [VN-Spoke]。
12. 在 [子網路] 中，按一下 [SN-Workload]。
13. 按一下 [確定]。
14. 按一下 [路由]，然後按一下 [新增]。
15. 在 [路由名稱] 中，鍵入 **FW-DG**。
16. 在 [位址首碼] 中，鍵入 **0.0.0.0/0**。
17. 在 [下一個躍點類型] 中，選取 [虛擬設備]。

    Azure 防火牆實際上是受控服務，但虛擬設備可在此情況下運作。
1. 在 [下一個躍點位址] 中，鍵入您先前記下的防火牆私人 IP 位址。
2. 按一下 [確定]。


## <a name="configure-a-dnat-rule"></a>設定 DNAT 規則

1. 開啟 **RG-DNAT-Test**，然後按一下 **FW-DNAT-test** 防火牆。 
1. 在 [FW-DNAT-test] 頁面的 [設定] 底下，按一下 [規則]。 
2. 按一下 [新增 DNAT 規則集合]。 
3. 在 [名稱] 中，輸入 **RC-DNAT-01**。 
1. 在 [優先順序] 中，鍵入 **200**。 
6. 在 [規則] 底下的 [名稱] 中，輸入 **RL-01**。 
7. 在 [來源位址] 中，輸入 *。 
8. 在 [目的地位址] 中，輸入防火牆的公用 IP 位址。 
9. 在 [目的地連接埠] 中，輸入 **3389**。 
10. 在 [轉譯的位址] 中，輸入 Srv-Workload 虛擬機器的私人 IP 位址。 
11. 在 [轉譯的連接埠] 中，輸入 **3389**。 
12. 按一下 [新增] 。 

## <a name="test-the-firewall"></a>測試防火牆

1. 將遠端桌面連線至防火牆公用 IP 位址。 您應該會連線到 **Srv-Workload** 虛擬機器。
3. 關閉遠端桌面。
4. 將 **RC-Net-01** 網路規則集合動作變更為 [拒絕]。
5. 嘗試再次連線至防火牆公用 IP 位址。 因為 [拒絕] 規則，所以這次應該不會成功。

## <a name="clean-up-resources"></a>清除資源

您可以保留防火牆資源供下一個教學課程使用，若不再需要，則可刪除 **RG-DNAT-Test** 資源群組來刪除所有防火牆相關資源。

## <a name="next-steps"></a>後續步驟

在本教學課程中，您已了解如何：

> [!div class="checklist"]
> * 設定測試網路環境
> * 部署防火牆
> * 建立預設路由
> * 設定 DNAT 規則
> * 測試防火牆

接下來，您可以監視 Azure 防火牆記錄。

> [!div class="nextstepaction"]
> [教學課程：監視 Azure 防火牆記錄](./tutorial-diagnostics.md)
