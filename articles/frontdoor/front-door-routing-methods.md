---
title: Azure Front Door Service - 流量路由方法 | Microsoft Docs
description: 本文將協助您了解 Front Door 所使用的不同流量路由方法
services: front-door
documentationcenter: ''
author: sharad4u
ms.service: frontdoor
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/10/2018
ms.author: sharadag
ms.openlocfilehash: 26b4e2b1bf2dc9e59bc41e1d9f0628a1f476d402
ms.sourcegitcommit: 4ecc62198f299fc215c49e38bca81f7eb62cdef3
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/24/2018
ms.locfileid: "47031472"
---
# <a name="front-door-routing-methods"></a>Front Door 路由方法

Azure Front Door Service 支援各種流量路由方法，以決定如何將您的 HTTP/HTTPS 流量路由傳送至不同服務端點。 當每個用戶端流量要求觸達 Front Door 時，便會套用設定的路由方法，確保將要求轉送至最佳後端執行個體。 

Front Door 中有四種可用的流量路由主要概念：

* **[延遲](#latency)：** 延遲式路由會確保將要求傳送至敏感度範圍中可接受的最低延遲後端。 基本上，您的使用者要求會根據網路延遲，傳送至「最近」的一組後端。
* **[優先順序](#priority)：** 如果您想要針對所有流量使用某個主要服務後端，則可以將優先順序指派給不同的後端，並提供備用方案，以防發生主要或備份後端無法使用的情況。
* **[加權](#weighted)：** 當您想要平均或是根據權數係數將流量分散到一組後端時，可以將權數指派給不同的後端。
* **[工作階段同質性](#sessionaffinity)：** 當您想要在使用者工作階段仍在使用中且後端執行個體仍根據健康狀態探查回報狀況良好，將來自使用者的後續要求傳送至相同後端時，您可以為前端主機或網域設定工作階段同質性。 

所有 Front Door 設定皆包含後端健康狀態監視及自動化的即時全域容錯移轉。 如需詳細資訊，請參閱 [Front Door 後端監視](front-door-health-probes.md)。 您的 Front Door 可設為以單一路由方法為基礎，並根據您的應用程式需求搭配使用多個或所有路由方法來建置最佳路由拓撲。

## <a name = "latency"></a>最低延遲式流量路由

如果將後端部署在全球的兩個或更多個位置，然後將流量路由傳送至「最靠近」您終端使用者的位置，即可改善許多應用程式的回應速度。 您 Front Door 設定的預設路由方法會將終端使用者要求轉送至與接收要求 Front Door 環境最靠近的後端。 結合 Azure Front Door Service 的任一傳播架構，此方法可確保每個終端使用者都能根據其位置，取得最大個人化效能。

「最靠近」的後端不一定是地理距離測量上最靠近的後端。 相反的，Front Door 會透過測量網路延遲來決定最靠近的後端。 深入了解 [Front Door 的路由架構](front-door-routing-architecture.md)。 

以下是整體的決策流程：

| 可用後端 | 優先順序 | 延遲訊號 (以健康狀態探查為基礎) | Weights |
|-------------| ----------- | ----------- | ----------- |
| 首先，選取所有已啟用且回報健康狀態探查狀況良好 (200-OK) 的後端。 假設有六個後端：A、B、C、D、E、F，其中 C 的狀況不良，E 處於未啟用狀態。 則可用後端清單為 A、B、D 和 F。  | 接下來，會從可用後端中選取優先順序最高的後端。 假設後端 A、B 和 D 的優先順序為 1，且後端 F 的優先順序為 2。 則選取的後端將為 A、B 和 D。| 選取具有延遲範圍的後端 (以毫秒指定最低延遲及延遲敏感度)。 假設與要求抵達的 Front Door 環境距離，A 為 15 毫秒、B 為 30 毫秒，D 為 60 毫秒，並且延遲敏感度為 30 毫秒，則最低延遲集區會由後端 A 和 B 組成，因為 D 距離最靠近的後端 (A) 超過 30 毫秒。 | 最後，Front Door 會在最終選取的後端集區中，根據指定權數比例循環配置流量。 假設後端 A 的權數為 5，後端 B 的權數為 8，則流量會在 A 和 B 間以 5:8 的比例進行分散。 |

>[!NOTE]
> 根據預設，延遲敏感度屬性會設為 0 毫秒，表示一律將要求轉送至最快的可用後端。


## <a name = "priority"></a>優先順序式流量路由

組織通常會部署一或多個備份服務，以防萬一主要服務停止運作時，可確保服務的可靠性。 在業界中，此拓撲也稱為拓撲「使用中/待命」或「主動/被動」部署拓撲。 「優先順序」流量路由方法可讓 Azure 客戶輕鬆實作此容錯移轉模式。

您的預設 Front Door 包含後端清單，其中每個後端都具有相同的優先順序。 根據預設，Front Door 只會將流量傳送到優先順序最高的後端 (優先順序值最低)，即後端的主要集合。 當無法使用主要後端時，Front Door 會將流量路由至後端的次要集合 (優先順序值次低)。 如果主要和次要端點都無法供使用，系統就會將流量傳送到第三個後端，依此類推。 後端的可用性是以設定狀態 (啟用或停用) 及健康狀態探查判斷的進行中後端健康狀態為基礎。

### <a name="configuring-priority-for-backends"></a>設定後端優先順序

Front Door 設定中每個後端集區內的後端都具有稱為「優先順序」的屬性，其數字介於 1 和 5 之間。 使用 Azure Front Door Service，您會使用此屬性明確設定每個後端的後端優先順序。 此屬性的值介於 1 到 5 之間。 值越低代表優先順序越高。 後端可以共用優先順序值。

## <a name = "weighted"></a>加權流量路由方法
「加權」流量路由方法可讓您平均分散流量，或使用預先定義的權數。

在加權流量路由方法中，您需要在您後端集區的 Front Door 設定中為每個後端指派權數。 權數是從 1 到 1000 的整數。 此參數使用預設權數 '50'。

在已接受延遲敏感度 (指定值) 內的可用後端清單中，流量會以循環配置資源機制，根據指定的權數比例進行分散。 若延遲敏感度設為 0 毫秒，則除非有兩個具有相同網路延遲的後端，否則此屬性不會生效。 

加權方法支援一些實用的案例︰

* **應用程式逐步升級**：配置要路由傳送到新後端的流量百分比，並隨時間逐漸增加流量到與其他後端相等。
* **應用程式移轉至 Azure**︰建立具有 Azure 和外部後端的後端集區。 調整後端的權數來優先使用新的後端。 您可以從停用新後端，再將最低權數指派給它們，並緩慢增加到使其接收最多流量的層級，來逐漸設定。 接著最後再停用較不慣用的後端，並從集區移除它們。  
* **額外容量的雲端高載**：透過將其放在 Front Door 之後，使內部部署快速展開至雲端。 當您需要在雲端中增加額外容量時，您可以新增或啟用更多後端並指定進入每個後端的流量比例。

## <a name = "affinity"></a>工作階段親和性
根據預設，當沒有工作階段親和性時，Front Door 會在流向不同後端的延遲變更時，或是在來自相同使用者的不同要求抵達不同 Front Door 環境時，特別根據負載平衡設定，將來自相同用戶端的要求轉送至不同後端。 但是，有些具狀態應用程式，或在某些其他案例中，會偏好來自相同使用的後續要求抵達處理初始要求的相同後端。 當您想要在同一個後端保留使用者工作階段時，以 Cookie 為基礎的工作階段親和性非常有用。 透過使用 Front Door 受控 Cookie，Azure Front Door Service 可在後端健康狀態良好且使用者工作階段尚未過期的情況下，將使用者工作階段的後續流量導向相同後端進行處理。 

工作階段親和性可在每個您設定網域 (或子網域) 的前端主機層級中啟用。 啟用之後，Front Door 便會將 Cookie 新增到使用者的工作階段。 根據 Cookie 的工作階段親和性可讓 Front Door 識別不同使用者 (即使使用者位於相同 IP 位址之後)，在您的不同後端間進行更平均的流量分散。

Cookie 的存留期與使用者工作階段相同，因為 Front Door 目前僅支援工作階段 Cookie。 

> [!NOTE]
> 公用 Proxy 可能會影響工作階段親和性。 這是因為建立工作階段需要 Front Door 將工作階段親和性 Cookie 新增至回應，因此若可針對回應進行快取，便會中斷要求相同資源的其他用戶端 Cookie。 為了避免此問題，工作階段親和性**不會**在後端嘗試傳送可快取的回應時建立。 若工作階段已建立，則無論來自後端的回應是否可進行快取，皆不會造成影響。
> **除非**回應具備 HTTP 304 狀態代碼，否則工作階段親和性便會在下列情況下建立：
> - 回應的 ```Cache-Control``` 標頭具有阻止快取的特定值組，例如 "private" 或 "no-store"。
> - 回應包含尚未過期的 ```Authorization``` 標頭。
> - 回應具備 HTTP 302 狀態代碼。

## <a name="next-steps"></a>後續步驟

- 了解如何[建立 Front Door](quickstart-create-front-door.md)。
- 了解 [Front Door 的運作方式](front-door-routing-architecture.md)。
