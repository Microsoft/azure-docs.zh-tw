---
title: Azure Log Analytics 中網路效能監控解決方案的效能監控功能 | Microsoft Docs
description: 網路效能監控中的效能監控功能可以協助您監控網路中各個點之間的網路連線。 您可以監控雲端部署和內部部署位置、多個資料中心和分公司，以及任務關鍵性多層式應用程式或微服務。
services: log-analytics
documentationcenter: ''
author: abshamsft
manager: carmonm
editor: ''
ms.assetid: 5b9c9c83-3435-488c-b4f6-7653003ae18a
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 02/20/2018
ms.author: abshamsft
ms.component: na
ms.openlocfilehash: 3d51399edbb9679d1cf7b62b075ba34aa5ede42f
ms.sourcegitcommit: 5892c4e1fe65282929230abadf617c0be8953fd9
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/29/2018
ms.locfileid: "37131333"
---
# <a name="network-performance-monitor-solution-performance-monitoring"></a>網路效能監控解決方案：效能監控

[網路效能監控](log-analytics-network-performance-monitor.md)中的效能監控功能可協助您監控網路中各個點之間的網路連線。 您可以監控雲端部署和內部部署位置、多個資料中心和分公司，以及任務關鍵性多層式應用程式或微服務。 利用效能監視器，您可以在使用者提出抱怨之前偵測到網路問題。 主要優點是您可以： 

- 監視各個子網路的遺失和延遲並設定警示。
- 監視網路上的所有路徑 (包括備援路徑)。
- 針對難以複寫的暫時性和時間點網路問題進行疑難排解。
- 判斷導致效能衰退的特定網路區段。
- 監視網路健康情況，而不需 SNMP。


![網路效能監視器](media/log-analytics-network-performance-monitor/npm-performance-monitor.png)

## <a name="configuration"></a>組態
若要開啟網路效能監控的組態，請開啟[網路效能監控解決方案](log-analytics-network-performance-monitor.md)，然後選取 [設定]。

![設定網路效能監控](media/log-analytics-network-performance-monitor/npm-configure-button.png)

### <a name="create-new-networks"></a>建立新網路

網路效能監視器中的網路是子網路的邏輯容器。 它可協助您根據您的需求來安排網路基礎結構的監控。 您可以使用好記的名稱來建立網路，並根據您的商務邏輯新增子網路。 例如，您可以在倫敦資料中心建立名為 London 的網路並新增所有子網路。 您也可以建立名為 ContosoFrontEnd 的網路，並將名為 Contoso 且作為應用程式前端的所有子網路新增到此網路。 解決方案會自動建立預設網路，其中包含您環境中探索到的所有子網路。 

每當您建立網路時，您可在其中新增子網路。 接著該子網路會從預設網路中移除。 如果您刪除網路，其所有子網路都會自動回到預設網路。 預設網路可作為所有未包含於使用者定義網路之子網路的容器。 您無法編輯或刪除預設網路。 它一定會保留在系統中。 您可以視需要建立任意數量的自訂網路。 在大部分情況下，組織中的子網路會安排在一個以上的網路。 建立一或多個網路，針對您的商務邏輯將子網路分組。

若要建立新網路：


1. 選取 [網路] 索引標籤。
1. 選取  **新增網路**，然後輸入網路名稱和描述。 
2. 選取一或多個子網路，然後選取 [新增]。 
3. 選取 [儲存] 以儲存組態。 


### <a name="create-monitoring-rules"></a>建立監視規則 

在違反 2 個子網路之間或 2 個網路之間網路連線的效能閾值時，效能監控會產生健康情況事件。 系統可以自動學習這些閾值。 您也可以提供自訂閾值。 系統會自動建立預設規則，它會在任何一對網路或子網路連結之間的遺失或延遲違反系統所學習的閾值時，產生健康情況事件。 在您未明確建立任何監視規則之前，這個程序可協助解決方案監視您的網路基礎結構。 如果已啟用預設規則，則所有節點都會傳送綜合交易至您已啟用監視的所有其他節點。 預設規則適用於小型網路。 例如，有少量執行微服務的伺服器，而且想要確定所有伺服器都已彼此連線。

>[!NOTE]
> 建議您停用預設規則，並建立自訂監視規則，特別是在您使用大量節點進行監視的大型網路情況下。 自訂監視規則可以減少解決方案產生的流量，並協助您安排網路的監控。

根據您的商務邏輯建立監控規則。 舉例來說，如果您想要監視兩個辦公室網站對總部的網路連線效能。 在網路 O1 中將辦公室網站1 的所有子網路群組在一起。 然後在網路 O2 中將辦公室網站2 的所有子網路群組在一起。 最後，在網路 H 中將總部的所有子網路群組在一起。建立兩個監視規則：一個規則適用於 O1 與 H 之間，另一個規則適用於 O2 與 H 之間。 

若要建立自訂監控規則：

1. 選取 [監視] 索引標籤上的 [新增規則]，然後輸入規則名稱和描述。
2. 從清單中選取一對要監視的網路或子網路連結。 
3. 從網路下拉式清單選取包含您想要之子網路的網路。 然後從對應的子網路下拉式清單中選取子網路。 如果您要監視網路連結中的所有子網路，請選取 [所有子網路]。 同樣地，選取您想要的其他子網路。 若要從您所做的選取範圍中排除特定子網路連結的監控，請選取 [新增例外狀況]。 
4. 選擇 ICMP 或 TCP 通訊協定，以執行綜合交易。 
5. 如果您不想建立所選項目的健康情況事件，則清除 [在此規則所涵蓋的連結上啟用健康情況監視]。 
6. 選擇監視條件。 若要設定健康情況事件產生的自訂閾值，請輸入閾值。 只要條件的值超過針對所選網路或子網路配對選取的閾值時，就會產生健康情況事件。 
7. 選取 [儲存] 以儲存組態。 

儲存監視規則之後，您可以選取 [建立警示]，使用警示管理來整合該規則。 警示規則會透過搜尋查詢自動建立。 系統會自動填入其他必要參數。 使用警示規則，除了網路效能監控內現有的警示，您還可以接收電子郵件型警示。 警示也可以使用 Runbook 觸發修復動作，或使用 Webhook 與現有的服務管理解決方案整合。 選取 [管理警示] 以編輯警示設定。 

您現在可以建立更多的效能監控規則或移動到解決方案儀表板，以便使用此功能。

### <a name="choose-the-protocol"></a>選擇通訊協定

網路效能監控使用綜合交易來計算網路效能計量，例如封包遺失和連結延遲。 若要進一步了解這個概念，請考慮連線到網路連結一端的網路效能監控代理程式。 此網路效能監控代理程式會將探查封包傳送到與網路另一端連線的第二個網路效能監控代理程式。 第二個代理程式會以回應封包回覆。 此程序會重複幾次。 藉由測量回應的數目及接收每個回應所花費的時間，第一個網路效能監控代理程式就可評估連結延遲和封包遺失。 

您在建立監視規則時所選擇的通訊協定，會決定這些封包的格式、大小和順序。 根據封包的通訊協定，中繼網路裝置 (例如路由器和交換器) 可能會以不同的方式處理這些封包。 因此，您的通訊協定選擇會影響結果的精確度。 您的通訊協定選擇也會決定在您部署網路效能監控解決方案後，是否必須採取任何手動步驟。 

網路效能監控提供 ICMP 和 TCP 通訊協定選項，供您用來執行綜合交易。 如果您在建立綜合交易規則時選擇 ICMP，網路效能監控代理程式會使用 ICMP ECHO 訊息來計算網路延遲和封包遺失。 ICMP ECHO 使用的訊息與傳統 Ping 公用程式傳送的訊息相同。 當您使用 TCP 作為通訊協定時，網路效能監控代理程式會透過網路傳送 TCP SYN 封包。 這個步驟的後續是 TCP 交握完成，然後使用 RST 封包移除連線。 

選擇通訊協定之前，您應該考慮下列資訊： 

* **探索多個網路路由。** TCP 在探索多個路由時精確度較高，而且在每個子網路中需要的代理程式較少。 例如，只要有一或二個使用 TCP 的代理程式，就可以探索子網路之間的所有備援路徑。 您需要數個使用 ICMP 的代理程式才能達到類似的結果。 如果使用 ICMP，假設您在 2 個子網路之間有 N 個路由，您在來源或目標子網路就需要超過 5N 個代理程式。

* **結果的精確度。** 路由器和交換器對於 ICMP ECHO 封包會指派比 TCP 封包較低的優先順序。 在某些情況下，當網路裝置處於大量負載狀態時，透過 TCP 取得的資料會更貼切地反映應用程式發生的遺失和延遲。 這是因為大部分的應用程式流量都是透過 TCP 傳送。 在這種情況下，ICMP 提供的結果精確度就不及 TCP。 

* **防火牆組態。** TCP 通訊協定會要求 TCP 封包傳送至目的地連接埠。 網路效能監控代理程式所使用的預設連接埠是 8084。 您可以在設定代理程式時變更此連接埠。 確定您的網路防火牆或網路安全性群組 (NSG) 規則 (在 Azure 中) 允許該連接埠的流量。 您也必須確定安裝代理程式的電腦本機防火牆設定為允許這個連接埠的流量。 您可以使用 PowerShell 指令碼在執行 Windows 的電腦上設定防火牆規則，但您必須手動設定網路防火牆。 相反地，ICMP 無法透過連接埠運作。 在大部分的企業案例中，會允許 ICMP 流量通過防火牆，讓您可以使用如 Ping 公用程式的網路診斷工具。 如果您可以從另一部電腦 Ping 某部電腦，則可以使用 ICMP 通訊協定，而不需要手動設定防火牆。

>[!NOTE] 
> 某些防火牆可能會封鎖 ICMP，這可能導致重新傳輸，進而在安全性資訊和事件管理系統中產生大量的事件。 請確定您所選擇的通訊協定未遭到網路防火牆或 NSG 封鎖。 否則，網路效能監控無法監視網路區段。 我們建議您使用 TCP 進行監視。 請在無法使用 TCP 的情況下使用 ICMP，例如以下情況： 
>
> - 您使用以 Windows 用戶端為基礎的節點，因為 Windows 用戶端中不允許 TCP 原始通訊端。
> - 您的網路防火牆或 NSG 封鎖 TCP。
> - 您不知道如何切換通訊協定。

如果您在部署期間選擇使用 ICMP，您可以隨時編輯預設監視規則來切換為 TCP。

1. 移至 **[效能監控]** > **[監視]** > **[設定]** > **[監視]**。 然後選取  **[預設規則]**。 
2. 捲動至 [通訊協定] 區段，然後選取您要使用的通訊協定。 
3. 選取 [儲存] 來套用設定。 

即使預設規則使用特定的通訊協定，您也能以其他通訊協定建立新規則。 您甚至可以建立混合規則，其中某些規則使用 ICMP，而其他規則使用 TCP。 

## <a name="walkthrough"></a>逐步介紹 

現在查看健康情況事件根本原因的簡單調查。

在解決方案儀表板上，健康情況事件顯示網路連結狀況不佳。 若要調查此問題，請選取 [受監控的網路連結] 圖格。

向下鑽研頁面會顯示 **DMZ2-DMZ1** 網路連結的狀況不良。 針對此網路連結選取 [檢視子網路連結]。 


向下鑽研頁面會顯示 **DMZ2-DMZ1** 網路連結中的所有子網路連結。 這兩個子網路連結的延遲已超過閾值，以致網路連結狀況不良。 您也可以查看這兩個子網路連結的延遲趨勢。 使用圖形中的時間選取控制項，將焦點放在所需的時間範圍。 您可以看到一天當中達到延遲尖峰的時間。 稍後在記錄中搜尋此時間，以調查問題。 選取 [檢視節點連結] 進一步深入鑽研。 
 
 ![子網路連結頁面](media/log-analytics-network-performance-monitor/subnetwork-links.png) 

類似於前一頁，特定子網路連結的向下鑽研頁面會列出其構成的節點連結。 您可以在這裡執行類似上一個步驟中的動作。 選取 [檢視拓撲] 可檢視 2 個節點之間的拓撲。 
 
 ![節點連結頁面](media/log-analytics-network-performance-monitor/node-links.png) 

2 個選定節點之間的所有路徑都會繪製於拓撲圖。 您可以在拓撲圖上呈現這兩個節點之間路由的逐一躍點拓撲。 拓撲圖會清楚顯示兩個節點之間有多少個路由，以及資料封包所採用的路徑。 網路效能瓶頸會以紅色顯示。 若要找出錯誤的網路連線或錯誤的網路裝置，請查看拓撲圖上的紅色元素。 

 ![具有拓撲圖的拓撲儀表板](media/log-analytics-network-performance-monitor/topology-dashboard.png) 

您可以在 [動作] 窗格中檢閱每個路徑中的遺失、延遲和躍點數目。 使用捲軸來檢視這些狀況不良路徑的詳細資料。 使用篩選器選取具有狀況不良躍點的路徑，以便僅繪製選取路徑的拓撲。 若要放大或縮小拓撲圖，請使用滑鼠滾輪。 

在下圖中，網路特定區段中問題區域的根本原因會以紅色路徑和躍點顯示。 選取拓撲圖中的節點，即可顯示該節點的屬性，包括 FQDN 和 IP 位址。 選取躍點即可顯示該躍點的 IP 位址。 
 
![已選取節點屬性的拓撲圖](media/log-analytics-network-performance-monitor/topology-dashboard-root-cause.png) 

## <a name="next-steps"></a>後續步驟
[搜尋記錄檔](log-analytics-log-searches.md)以檢視詳細的網路效能資料記錄。
