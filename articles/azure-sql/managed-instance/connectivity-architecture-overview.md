---
title: 連線架構
titleSuffix: Azure SQL Managed Instance
description: 瞭解 Azure SQL 受控執行個體通訊和連線架構，以及元件如何將流量導向至受控實例。
services: sql-database
ms.service: sql-managed-instance
ms.subservice: operations
ms.custom: fasttrack-edit
ms.devlang: ''
ms.topic: conceptual
author: srdan-bozovic-msft
ms.author: srbozovi
ms.reviewer: sstein, bonova
ms.date: 10/22/2020
ms.openlocfilehash: 58563629b30e7be764732a9810162e1a0b1931e6
ms.sourcegitcommit: 78ecfbc831405e8d0f932c9aafcdf59589f81978
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/23/2021
ms.locfileid: "98725831"
---
# <a name="connectivity-architecture-for-azure-sql-managed-instance"></a>Azure SQL 受控執行個體的連線架構
[!INCLUDE[appliesto-sqlmi](../includes/appliesto-sqlmi.md)]

本文說明 Azure SQL 受控執行個體中的通訊。 它也會說明連線架構，以及元件如何將流量導向至受控實例。  

SQL 受控執行個體放在 Azure 虛擬網路和受控實例專用的子網內。 此部署提供：

- 安全的私人 IP 位址。
- 將內部部署網路連線至 SQL 受控執行個體的能力。
- 將 SQL 受控執行個體連接到連結的伺服器或其他內部部署資料存放區的能力。
- 將 SQL 受控執行個體連接至 Azure 資源的能力。

## <a name="communication-overview"></a>通訊概觀

下圖顯示連接至 SQL 受控執行個體的實體。 它也會顯示需要與受控實例通訊的資源。 圖底部的通訊程式代表客戶應用程式和工具，會以資料來源的形式連接到 SQL 受控執行個體。  

![連線性架構中的實體](./media/connectivity-architecture-overview/connectivityarch001.png)

SQL 受控執行個體是一種平臺即服務， (PaaS) 供應專案。 Azure 會使用自動化代理程式 (管理、部署和維護) ，以根據遙測資料流程來管理此服務。 因為 Azure 負責管理，所以客戶無法透過遠端桌面通訊協定 (RDP) 來存取 SQL 受控執行個體的虛擬叢集電腦。

終端使用者或應用程式所啟動的某些作業可能需要 SQL 受控執行個體，才能與平臺互動。 其中一種情況是建立 SQL 受控執行個體資料庫。 此資源會透過 Azure 入口網站、PowerShell、Azure CLI 和 REST API 來公開。

SQL 受控執行個體相依于 Azure 服務，例如適用于備份的 Azure 儲存體、適用于遙測的 Azure 事件中樞、Azure Active Directory (Azure AD) 進行驗證、Azure Key Vault 透明資料加密 (TDE) ，以及一些提供安全性與支援能力功能的 Azure 平臺服務。 SQL 受控執行個體會連接到這些服務。

所有通訊都會使用憑證來加密及簽署。 為了檢查通訊雙方的可信度，SQL 受控執行個體會透過憑證撤銷清單，持續驗證這些憑證。 如果憑證遭到撤銷，SQL 受控執行個體會關閉連接以保護資料。

## <a name="high-level-connectivity-architecture"></a>高層級連線架構

概括而言，SQL 受控執行個體是一組服務元件。 這些元件裝載于一組在客戶的虛擬網路子網內執行的專用獨立虛擬機器。 這些機器構成虛擬叢集。

虛擬叢集可以裝載多個受控實例。 如有需要，當客戶變更子網中已布建的實例數目時，叢集會自動擴充或合約。

客戶應用程式可以連線到 SQL 受控執行個體，並且可以查詢和更新虛擬網路、對等互連虛擬網路或 VPN 或 Azure ExpressRoute 所連線的網路內的資料庫。 此網路必須使用端點和私人 IP 位址。  

![連接架構圖表](./media/connectivity-architecture-overview/connectivityarch002.png)

Azure 管理和部署服務會在虛擬網路外部執行。 SQL 受控執行個體和 Azure 服務會透過具有公用 IP 位址的端點進行連接。 當 SQL 受控執行個體建立輸出連線時，在接收端網路位址轉譯 (NAT) 讓連線看起來像是來自此公用 IP 位址。

管理流量會流經客戶的虛擬網路。 這表示，虛擬網路基礎結構的元素可能會導致實例失敗並變成無法使用，進而損害管理流量。

> [!IMPORTANT]
> 為了改善客戶體驗和服務可用性，Azure 會在 Azure 虛擬網路基礎結構元素上套用網路意圖原則。 原則可能會影響 SQL 受控執行個體的運作方式。 此平臺機制會將網路需求明確地傳達給使用者。 原則的主要目標是要防止網路設定錯誤，並確保正常的 SQL 受控執行個體作業。 當您刪除受控實例時，也會移除網路意圖原則。

## <a name="virtual-cluster-connectivity-architecture"></a>虛擬叢集連線架構

讓我們更深入瞭解 SQL 受控執行個體的連接架構。 下圖顯示虛擬叢集的概念性配置。

![虛擬叢集的連線架構](./media/connectivity-architecture-overview/connectivityarch003.png)

用戶端會使用具有格式的主機名稱連接到 SQL 受控執行個體 `<mi_name>.<dns_zone>.database.windows.net` 。 這個主機名稱會解析為私人 IP 位址，雖然它是在公用網域名稱系統中註冊 (DNS) 區域，而且可公開解析。 `zone-id`當您建立叢集時，會自動產生。 如果新建立的叢集裝載次要受控實例，它會與主要叢集共用其區域識別碼。 如需詳細資訊，請參閱 [使用自動容錯移轉群組來啟用多個資料庫的透明和協調容錯移轉](../database/auto-failover-group-overview.md#enabling-geo-replication-between-managed-instances-and-their-vnets)。

此私人 IP 位址屬於 SQL 受控執行個體的內部負載平衡器。 負載平衡器會將流量導向至 SQL 受控執行個體閘道。 因為多個受控實例可以在相同的叢集中執行，所以閘道會使用 SQL 受控執行個體主機名稱，將流量重新導向至正確的 SQL 引擎服務。

管理和部署服務會使用對應到外部負載平衡器的 [管理端點](#management-endpoint) ，連接到 SQL 受控執行個體。 只有在已預先定義的一組埠上收到流量時，才會將流量路由傳送至節點，這些埠僅限 SQL 受控執行個體使用的管理元件。 節點上的內建防火牆設定為只允許來自 Microsoft IP 範圍的流量。 憑證會相互驗證管理元件與管理平面之間的所有通訊。

## <a name="management-endpoint"></a>管理端點

Azure 會使用管理端點來管理 SQL 受控執行個體。 此端點位於實例的虛擬叢集內。 管理端點會受到網路層級內建防火牆的保護。 在應用層級上，它是由相互憑證驗證所保護。 若要尋找端點的 IP 位址，請參閱 [判斷管理端點的 ip 位址](management-endpoint-find-ip-address.md)。

當連線在 SQL 受控執行個體內啟動時 (與備份和審核記錄) 一樣，流量看起來會從管理端點的公用 IP 位址開始。 您可以設定防火牆規則只允許 SQL 受控執行個體的 IP 位址，以限制從 SQL 受控執行個體存取公用服務。 如需詳細資訊，請參閱 [驗證 SQL 受控執行個體內建防火牆](management-endpoint-verify-built-in-firewall.md)。

> [!NOTE]
> 移至位於 SQL 受控執行個體區域內之 Azure 服務的流量已優化，因此未 NATed 至管理端點的公用 IP 位址。 基於這個理由，如果您需要使用以 IP 為基礎的防火牆規則（最常用於儲存體），則服務必須位於 SQL 受控執行個體的不同區域中。

## <a name="service-aided-subnet-configuration"></a>服務輔助的子網路組態

為解決客戶的安全性與管理性需求，SQL 受控執行個體正在從手動轉換為服務輔助子網設定。

有了服務輔助子網設定，使用者就可以完全掌控 (TDS) 流量的資料，而 SQL 受控執行個體會負責確保管理流量不中斷，以履行 SLA。

服務輔助子網設定建置於虛擬網路 [子網委派](../../virtual-network/subnet-delegation-overview.md) 功能之上，以提供自動網路設定管理並啟用服務端點。 

您可以使用服務端點，在保留備份和審核記錄的儲存體帳戶上設定虛擬網路防火牆規則。 即使已啟用服務端點，仍建議客戶使用 [private link](../../private-link/private-link-overview.md) ，以提供服務端點的額外安全性。

> [!IMPORTANT]
> 由於控制平面設定特例，服務輔助子網設定不會在國家雲端中啟用服務端點。 

### <a name="network-requirements"></a>網路需求

將 SQL 受控執行個體部署在虛擬網路內的專用子網中。 子網路具有下列特性：

- **專用子網：** SQL 受控執行個體子網不能包含與其相關聯的任何其他雲端服務，也不能是閘道子網。 子網不能包含任何資源，但 SQL 受控執行個體，您稍後無法在子網中新增其他類型的資源。
- **子網委派：** SQL 受控執行個體子網必須委派給 `Microsoft.Sql/managedInstances` 資源提供者。
- **(NSG) 的網路安全性群組：** NSG 必須與 SQL 受控執行個體子網相關聯。 您可以使用 NSG 來控制 sql 受控執行個體資料端點的存取權，方法是在 SQL 受控執行個體設定為重新導向連接時，篩選埠1433和埠11000-11999 上的流量。 此服務將會自動布建並保留所需的最新 [規則](#mandatory-inbound-security-rules-with-service-aided-subnet-configuration) ，以允許不中斷的管理流量流程。
- **使用者定義的路由 (UDR) 資料表：** UDR 資料表必須與 SQL 受控執行個體子網相關聯。 您可以在路由表中新增項目，以透過虛擬網路閘道或虛擬網路設備 (NVA) 路由傳送內部部署私人 IP 範圍作為目的地的流量。 服務會自動佈建並將目前的[項目](#user-defined-routes-with-service-aided-subnet-configuration)保留為必要項目，才能確保管理流量的流程不會中斷。
- **足夠的 IP 位址：** SQL 受控執行個體子網至少必須有32個 IP 位址。 如需詳細資訊，請參閱 [決定 SQL 受控執行個體的子網大小](vnet-subnet-determine-size.md)。 當您設定受控實例以滿足[SQL 受控執行個體的網路需求](#network-requirements)之後，就可以在[現有網路](vnet-existing-add-subnet.md)中部署受控實例。 否則，請建立[新的網路和子網](virtual-network-subnet-create-arm-template.md)。

> [!IMPORTANT]
> 當您建立受控實例時，網路意圖原則會套用至子網，以防止不相容的網路設定變更。 從子網移除最後一個實例之後，也會移除網路意圖原則。 以下規則僅供資訊參考之用，您不應該使用 ARM 範本/PowerShell/CLI 來部署它們。 如果您想要使用最新的官方範本，您一律可以 [從入口網站取得](../../azure-resource-manager/templates/quickstart-create-templates-use-the-portal.md)。

### <a name="mandatory-inbound-security-rules-with-service-aided-subnet-configuration"></a>具有服務輔助子網設定的強制輸入安全性規則

| 名稱       |連接埠                        |通訊協定|來源           |Destination|動作|
|------------|----------------------------|--------|-----------------|-----------|------|
|管理  |9000、9003、1438、1440、1452|TCP     |SqlManagement    |MI SUBNET  |Allow |
|            |9000、9003                  |TCP     |CorpnetSaw       |MI SUBNET  |Allow |
|            |9000、9003                  |TCP     |CorpnetPublic    |MI SUBNET  |Allow |
|mi_subnet   |任意                         |任意     |MI SUBNET        |MI SUBNET  |Allow |
|health_probe|任意                         |任意     |AzureLoadBalancer|MI SUBNET  |Allow |

### <a name="mandatory-outbound-security-rules-with-service-aided-subnet-configuration"></a>具有服務輔助子網設定的強制輸出安全性規則

| 名稱       |連接埠          |通訊協定|來源           |Destination|動作|
|------------|--------------|--------|-----------------|-----------|------|
|管理  |443、12000    |TCP     |MI SUBNET        |AzureCloud |Allow |
|mi_subnet   |任意           |任意     |MI SUBNET        |MI SUBNET  |Allow |

### <a name="user-defined-routes-with-service-aided-subnet-configuration"></a>具有服務輔助子網設定的使用者定義路由

|Name|位址首碼|下一個躍點|
|----|--------------|-------|
|子網對 vnetlocal|MI SUBNET|虛擬網路|
|mi-13-64-11-nexthop-網際網路|13.64.0.0/11|網際網路|
|mi-13-104-14-nexthop-網際網路|13.104.0.0/14|網際網路|
|mi-20-33-16-nexthop-網際網路|20.33.0.0/16|網際網路|
|mi-20-34-15-nexthop-網際網路|20.34.0.0/15|網際網路|
|mi-20-36-14-nexthop-網際網路|20.36.0.0/14|網際網路|
|mi-20-40-13-nexthop-網際網路|20.40.0.0/13|網際網路|
|mi-20-48-12-nexthop-網際網路|20.48.0.0/12|網際網路|
|mi-20-64-10-nexthop-網際網路|20.64.0.0/10|網際網路|
|mi-20-128-16-nexthop-網際網路|20.128.0.0/16|網際網路|
|mi-20-135-16-nexthop-網際網路|20.135.0.0/16|網際網路|
|mi-20-136-16-nexthop-網際網路|20.136.0.0/16|網際網路|
|mi-20-140-15-nexthop-網際網路|20.140.0.0/15|網際網路|
|mi-20-143-16-nexthop-網際網路|20.143.0.0/16|網際網路|
|mi-20-144-14-nexthop-網際網路|20.144.0.0/14|網際網路|
|mi-20-150-15-nexthop-網際網路|20.150.0.0/15|網際網路|
|mi-20-160-12-nexthop-網際網路|20.160.0.0/12|網際網路|
|mi-20-176-14-nexthop-網際網路|20.176.0.0/14|網際網路|
|mi-20-180-14-nexthop-網際網路|20.180.0.0/14|網際網路|
|mi-20-184-13-nexthop-網際網路|20.184.0.0/13|網際網路|
|mi-20-192-10-nexthop-網際網路|20.192.0.0/10|網際網路|
|mi-40-64-10-nexthop-網際網路|40.64.0.0/10|網際網路|
|mi-51-4-15-nexthop-網際網路|51.4.0.0/15|網際網路|
|mi-51-8-16-nexthop-網際網路|51.8.0.0/16|網際網路|
|mi-51-10-15-nexthop-網際網路|51.10.0.0/15|網際網路|
|mi-51-18-16-nexthop-網際網路|51.18.0.0/16|網際網路|
|mi-51-51-16-nexthop-網際網路|51.51.0.0/16|網際網路|
|mi-51-53-16-nexthop-網際網路|51.53.0.0/16|網際網路|
|mi-51-103-16-nexthop-網際網路|51.103.0.0/16|網際網路|
|mi-51-104-15-nexthop-網際網路|51.104.0.0/15|網際網路|
|mi-51-132-16-nexthop-網際網路|51.132.0.0/16|網際網路|
|mi-51-136-15-nexthop-網際網路|51.136.0.0/15|網際網路|
|mi-51-138-16-nexthop-網際網路|51.138.0.0/16|網際網路|
|mi-51-140-14-nexthop-網際網路|51.140.0.0/14|網際網路|
|mi-51-144-15-nexthop-網際網路|51.144.0.0/15|網際網路|
|mi-52-96-12-nexthop-網際網路|52.96.0.0/12|網際網路|
|mi-52-112-14-nexthop-網際網路|52.112.0.0/14|網際網路|
|mi-52-125-16-nexthop-網際網路|52.125.0.0/16|網際網路|
|mi-52-126-15-nexthop-網際網路|52.126.0.0/15|網際網路|
|mi-52-130-15-nexthop-網際網路|52.130.0.0/15|網際網路|
|mi-52-132-14-nexthop-網際網路|52.132.0.0/14|網際網路|
|mi-52-136-13-nexthop-網際網路|52.136.0.0/13|網際網路|
|mi-52-145-16-nexthop-網際網路|52.145.0.0/16|網際網路|
|mi-52-146-15-nexthop-網際網路|52.146.0.0/15|網際網路|
|mi-52-148-14-nexthop-網際網路|52.148.0.0/14|網際網路|
|mi-52-152-13-nexthop-網際網路|52.152.0.0/13|網際網路|
|mi-52-160-11-nexthop-網際網路|52.160.0.0/11|網際網路|
|mi-52-224-11-nexthop-網際網路|52.224.0.0/11|網際網路|
|mi-64-4-18-nexthop-網際網路|64.4.0.0/18|網際網路|
|mi-65-52-14-nexthop-網際網路|65.52.0.0/14|網際網路|
|mi-66-119-144-20-nexthop-網際網路|66.119.144.0/20|網際網路|
|mi-70-37-17-nexthop-網際網路|70.37.0.0/17|網際網路|
|mi-70-37-128-18-nexthop-網際網路|70.37.128.0/18|網際網路|
|mi-91-190-216-21-nexthop-網際網路|91.190.216.0/21|網際網路|
|mi-94-245-64-18-nexthop-網際網路|94.245.64.0/18|網際網路|
|mi-103-9-8-22-nexthop-網際網路|103.9.8.0/22|網際網路|
|mi-103-25-156-24-nexthop-網際網路|103.25.156.0/24|網際網路|
|mi-103-25-157-24-nexthop-網際網路|103.25.157.0/24|網際網路|
|mi-103-25-158-23-nexthop-網際網路|103.25.158.0/23|網際網路|
|mi-103-36-96-22-nexthop-網際網路|103.36.96.0/22|網際網路|
|mi-103-255-140-22-nexthop-網際網路|103.255.140.0/22|網際網路|
|mi-104-40-13-nexthop-網際網路|104.40.0.0/13|網際網路|
|mi-104-146-15-nexthop-網際網路|104.146.0.0/15|網際網路|
|mi-104-208-13-nexthop-網際網路|104.208.0.0/13|網際網路|
|mi-111-221-16-20-nexthop-網際網路|111.221.16.0/20|網際網路|
|mi-111-221-64-18-nexthop-網際網路|111.221.64.0/18|網際網路|
|mi-129-75-16-nexthop-網際網路|129.75.0.0/16|網際網路|
|mi-131-107-16-nexthop-網際網路|131.107.0.0/16|網際網路|
|mi-131-253-1-24-nexthop-網際網路|131.253.1.0/24|網際網路|
|mi-131-253-3-24-nexthop-網際網路|131.253.3.0/24|網際網路|
|mi-131-253-5-24-nexthop-網際網路|131.253.5.0/24|網際網路|
|mi-131-253-6-24-nexthop-網際網路|131.253.6.0/24|網際網路|
|mi-131-253-8-24-nexthop-網際網路|131.253.8.0/24|網際網路|
|mi-131-253-12-22-nexthop-網際網路|131.253.12.0/22|網際網路|
|mi-131-253-16-23-nexthop-網際網路|131.253.16.0/23|網際網路|
|mi-131-253-18-24-nexthop-網際網路|131.253.18.0/24|網際網路|
|mi-131-253-21-24-nexthop-網際網路|131.253.21.0/24|網際網路|
|mi-131-253-22-23-nexthop-網際網路|131.253.22.0/23|網際網路|
|mi-131-253-24-21-nexthop-網際網路|131.253.24.0/21|網際網路|
|mi-131-253-32-20-nexthop-網際網路|131.253.32.0/20|網際網路|
|mi-131-253-61-24-nexthop-網際網路|131.253.61.0/24|網際網路|
|mi-131-253-62-23-nexthop-網際網路|131.253.62.0/23|網際網路|
|mi-131-253-64-18-nexthop-網際網路|131.253.64.0/18|網際網路|
|mi-131-253-128-17-nexthop-網際網路|131.253.128.0/17|網際網路|
|mi-132-245-16-nexthop-網際網路|132.245.0.0/16|網際網路|
|mi-134-170-16-nexthop-網際網路|134.170.0.0/16|網際網路|
|mi-134-177-16-nexthop-網際網路|134.177.0.0/16|網際網路|
|mi-137-116-15-nexthop-網際網路|137.116.0.0/15|網際網路|
|mi-137-135-16-nexthop-網際網路|137.135.0.0/16|網際網路|
|mi-138-91-16-nexthop-網際網路|138.91.0.0/16|網際網路|
|mi-138-196-16-nexthop-網際網路|138.196.0.0/16|網際網路|
|mi-139-217-16-nexthop-網際網路|139.217.0.0/16|網際網路|
|mi-139-219-16-nexthop-網際網路|139.219.0.0/16|網際網路|
|mi-141-251-16-nexthop-網際網路|141.251.0.0/16|網際網路|
|mi-146-147-16-nexthop-網際網路|146.147.0.0/16|網際網路|
|mi-147-243-16-nexthop-網際網路|147.243.0.0/16|網際網路|
|mi-150-171-16-nexthop-網際網路|150.171.0.0/16|網際網路|
|mi-150-242-48-22-nexthop-網際網路|150.242.48.0/22|網際網路|
|mi-157-54-15-nexthop-網際網路|157.54.0.0/15|網際網路|
|mi-157-56-14-nexthop-網際網路|157.56.0.0/14|網際網路|
|mi-157-60-16-nexthop-網際網路|157.60.0.0/16|網際網路|
|mi-167-105-16-nexthop-網際網路|167.105.0.0/16|網際網路|
|mi-167-220-16-nexthop-網際網路|167.220.0.0/16|網際網路|
|mi-168-61-16-nexthop-網際網路|168.61.0.0/16|網際網路|
|mi-168-62-15-nexthop-網際網路|168.62.0.0/15|網際網路|
|mi-191-232-13-nexthop-網際網路|191.232.0.0/13|網際網路|
|mi-192-32-16-nexthop-網際網路|192.32.0.0/16|網際網路|
|mi-192-48-225-24-nexthop-網際網路|192.48.225.0/24|網際網路|
|mi-192-84-159-24-nexthop-網際網路|192.84.159.0/24|網際網路|
|mi-192-84-160-23-nexthop-網際網路|192.84.160.0/23|網際網路|
|mi-192-197-157-24-nexthop-網際網路|192.197.157.0/24|網際網路|
|mi-193-149-64-19-nexthop-網際網路|193.149.64.0/19|網際網路|
|mi-193-221-113-24-nexthop-網際網路|193.221.113.0/24|網際網路|
|mi-194-69-96-19-nexthop-網際網路|194.69.96.0/19|網際網路|
|mi-194-110-197-24-nexthop-網際網路|194.110.197.0/24|網際網路|
|mi-198-105-232-22-nexthop-網際網路|198.105.232.0/22|網際網路|
|mi-198-200-130-24-nexthop-網際網路|198.200.130.0/24|網際網路|
|mi-198-206-164-24-nexthop-網際網路|198.206.164.0/24|網際網路|
|mi-199-60-28-24-nexthop-網際網路|199.60.28.0/24|網際網路|
|mi-199-74-210-24-nexthop-網際網路|199.74.210.0/24|網際網路|
|mi-199-103-90-23-nexthop-網際網路|199.103.90.0/23|網際網路|
|mi-199-103-122-24-nexthop-網際網路|199.103.122.0/24|網際網路|
|mi-199-242-32-20-nexthop-網際網路|199.242.32.0/20|網際網路|
|mi-199-242-48-21-nexthop-網際網路|199.242.48.0/21|網際網路|
|mi-202-89-224-20-nexthop-網際網路|202.89.224.0/20|網際網路|
|mi-204-13-120-21-nexthop-網際網路|204.13.120.0/21|網際網路|
|mi-204-14-180-22-nexthop-網際網路|204.14.180.0/22|網際網路|
|mi-204-79-135-24-nexthop-網際網路|204.79.135.0/24|網際網路|
|mi-204-79-179-24-nexthop-網際網路|204.79.179.0/24|網際網路|
|mi-204-79-181-24-nexthop-網際網路|204.79.181.0/24|網際網路|
|mi-204-79-188-24-nexthop-網際網路|204.79.188.0/24|網際網路|
|mi-204-79-195-24-nexthop-網際網路|204.79.195.0/24|網際網路|
|mi-204-79-196-23-nexthop-網際網路|204.79.196.0/23|網際網路|
|mi-204-79-252-24-nexthop-網際網路|204.79.252.0/24|網際網路|
|mi-204-152-18-23-nexthop-網際網路|204.152.18.0/23|網際網路|
|mi-204-152-140-23-nexthop-網際網路|204.152.140.0/23|網際網路|
|mi-204-231-192-24-nexthop-網際網路|204.231.192.0/24|網際網路|
|mi-204-231-194-23-nexthop-網際網路|204.231.194.0/23|網際網路|
|mi-204-231-197-24-nexthop-網際網路|204.231.197.0/24|網際網路|
|mi-204-231-198-23-nexthop-網際網路|204.231.198.0/23|網際網路|
|mi-204-231-200-21-nexthop-網際網路|204.231.200.0/21|網際網路|
|mi-204-231-208-20-nexthop-網際網路|204.231.208.0/20|網際網路|
|mi-204-231-236-24-nexthop-網際網路|204.231.236.0/24|網際網路|
|mi-205-174-224-20-nexthop-網際網路|205.174.224.0/20|網際網路|
|mi-206-138-168-21-nexthop-網際網路|206.138.168.0/21|網際網路|
|mi-206-191-224-19-nexthop-網際網路|206.191.224.0/19|網際網路|
|mi-207-46-16-nexthop-網際網路|207.46.0.0/16|網際網路|
|mi-207-68-128-18-nexthop-網際網路|207.68.128.0/18|網際網路|
|mi-208-68-136-21-nexthop-網際網路|208.68.136.0/21|網際網路|
|mi-208-76-44-22-nexthop-網際網路|208.76.44.0/22|網際網路|
|mi-208-84-21-nexthop-網際網路|208.84.0.0/21|網際網路|
|mi-209-240-192-19-nexthop-網際網路|209.240.192.0/19|網際網路|
|mi-213-199-128-18-nexthop-網際網路|213.199.128.0/18|網際網路|
|mi-216-32-180-22-nexthop-網際網路|216.32.180.0/22|網際網路|
|mi-216-220-208-20-nexthop-網際網路|216.220.208.0/20|網際網路|
|mi-23-96-13-nexthop-網際網路|23.96.0.0/13|網際網路|
|mi-42-159-16-nexthop-網際網路|42.159.0.0/16|網際網路|
|mi-51-13-17-nexthop-網際網路|51.13.0.0/17|網際網路|
|mi-51-107-16-nexthop-網際網路|51.107.0.0/16|網際網路|
|mi-51-116-16-nexthop-網際網路|51.116.0.0/16|網際網路|
|mi-51-120-16-nexthop-網際網路|51.120.0.0/16|網際網路|
|mi-51-120-128-17-nexthop-網際網路|51.120.128.0/17|網際網路|
|mi-51-124-16-nexthop-網際網路|51.124.0.0/16|網際網路|
|mi-102-37-18-nexthop-網際網路|102.37.0.0/18|網際網路|
|mi-102-133-16-nexthop-網際網路|102.133.0.0/16|網際網路|
|mi-199-30-16-20-nexthop-網際網路|199.30.16.0/20|網際網路|
|mi-204-79-180-24-nexthop-網際網路|204.79.180.0/24|網際網路|
||||

\* MI 子網是以 x.x.x.x/y 格式參考子網的 IP 位址範圍。 您可以在 [子網屬性] 的 [Azure 入口網站] 中找到這項資訊。

\** 如果目的地位址適用于 Azure 的其中一個服務，Azure 會透過 Azure 骨幹網路將流量直接路由傳送至服務，而不是將流量路由傳送至網際網路。 不論虛擬網路存在哪一個 Azure 區域，或 Azure 服務執行個體部署在哪一個 Azure 區域，Azure 服務之間的流量都不會周遊網際網路。 如需詳細資料，請參閱 [UDR 檔頁面](../../virtual-network/virtual-networks-udr-overview.md)。

此外，您可以將專案新增至路由表，以透過虛擬網路閘道或虛擬網路設備 (NVA) ，將內部部署私人 IP 範圍的流量路由傳送至目的地。

如果虛擬網路包含自訂 DNS，則自訂 DNS 伺服器必須能夠解析公用 DNS 記錄。 使用 Azure AD 驗證等其他功能可能需要解析額外的 Fqdn。 如需詳細資訊，請參閱 [設定自訂 DNS](custom-dns-configure.md)。

### <a name="networking-constraints"></a>網路條件約束

**輸出連線強制執行 tls 1.2**：在年 1 2020 月，Microsoft 對所有 Azure 服務中的服務內流量強制使用 tls 1.2。 針對 Azure SQL 受控執行個體，這會導致在用於複寫的輸出連線和連結的伺服器連接到 SQL Server 上，強制執行 TLS 1.2。 如果您使用的 SQL Server 版本早于2016的 SQL 受控執行個體，請確定已套用 [TLS 1.2 特定的更新](https://support.microsoft.com/help/3135244/tls-1-2-support-for-microsoft-sql-server) 。

SQL 受控執行個體目前 *不支援* 下列虛擬網路功能：

- **Microsoft 對等互連**：在 ExpressRoute 線路上啟用 [microsoft 對等互連](../../expressroute/expressroute-faqs.md#microsoft-peering) 對等互連直接或透過 sql 受控執行個體所在的虛擬網路，對虛擬網路內的 sql 受控執行個體元件與其相依的服務之間的流量產生影響，進而造成可用性問題。 已啟用 Microsoft 對等互連之虛擬網路的 SQL 受控執行個體部署預期會失敗。
- **全域虛擬網路對等互連**：跨 Azure 區域的 [虛擬網路對等互連](../../virtual-network/virtual-network-peering-overview.md) 連線不適用於在9/22/2020 之前建立的子網中的 SQL 受控實例。
- **AzurePlatformDNS**：使用 AzurePlatformDNS [服務標記](../../virtual-network/service-tags-overview.md) 來封鎖平臺 DNS 解析會導致 SQL 受控執行個體無法使用。 雖然 SQL 受控執行個體支援客戶定義的 DNS 解析引擎內的 DNS，但平臺作業的平臺 DNS 有相依性。
- **NAT 閘道**：使用 [AZURE 虛擬網路 NAT](../../virtual-network/nat-overview.md) 來控制特定公用 IP 位址的輸出連線能力，會導致 SQL 受控執行個體無法使用。 SQL 受控執行個體服務目前僅限使用基本負載平衡器，不會提供使用虛擬網路 NAT 的輸入和輸出流量共存。
- **適用于 Azure 虛擬網路的 IPv6**：將 SQL 受控執行個體部署到 [雙 Stack IPv4/IPv6 虛擬網路](../../virtual-network/ipv6-overview.md) 預期會失敗。 將網路安全性群組 (NSG) 或路由表的關聯 (UDR) 包含 IPv6 位址首碼至 SQL 受控執行個體子網，或將 IPv6 位址首碼新增至已與受控實例子網建立關聯的 NSG 或 UDR，將會導致 SQL 受控執行個體無法使用。 SQL 受控執行個體部署至已具有 IPv6 首碼的 NSG 和 UDR 子網，預期會失敗。

## <a name="next-steps"></a>後續步驟

- 如需總覽，請參閱 [什麼是 AZURE SQL 受控執行個體？](sql-managed-instance-paas-overview.md)。
- 瞭解如何 [設定新的 azure 虛擬網路](virtual-network-subnet-create-arm-template.md) 或 [現有的 azure 虛擬網路](vnet-existing-add-subnet.md) ，您可以在其中部署 SQL 受控執行個體。
- 計算您要在其中部署 SQL 受控執行個體的[子網大小](vnet-subnet-determine-size.md)。
- 瞭解如何建立受控實例：
  - 從 [Azure 入口網站](instance-create-quickstart.md)。
  - 使用 [PowerShell](scripts/create-configure-managed-instance-powershell.md)。
  - 使用 [Azure Resource Manager 範本](https://azure.microsoft.com/resources/templates/101-sqlmi-new-vnet/)。
  - 使用 [Azure Resource Manager 範本 (使用 JumpBox，並包含) 的 SSMS ](https://azure.microsoft.com/resources/templates/201-sqlmi-new-vnet-w-jumpbox/)。