---
title: 關於 Azure VM 備份
description: 在本文中，您將瞭解 Azure 備份服務如何備份 Azure 虛擬機器，以及如何遵循最佳作法。
ms.topic: conceptual
ms.date: 09/13/2019
ms.openlocfilehash: 691fe991ad141696c0c68e915d7225001a1befd0
ms.sourcegitcommit: 78ecfbc831405e8d0f932c9aafcdf59589f81978
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/23/2021
ms.locfileid: "98733565"
---
# <a name="an-overview-of-azure-vm-backup"></a>Azure VM 備份的總覽

本文說明 [Azure 備份服務](./backup-overview.md) 如何)  (vm 來備份 Azure 虛擬機器。

Azure 備份提供獨立、隔離的備份，以防止您的 VM 上發生非預期的資料損毀。 備份會儲存在復原服務保存庫中，其具有內建的復原點管理功能。 設定及擴縮很簡單，備份已最佳化，而且您可以視需要輕鬆地還原。

在備份過程中， [會建立快照](#snapshot-creation)集，並將資料傳輸至復原服務保存庫，而不會影響生產工作負載。 快照集會提供不同層級的一致性[，如下所述。](#snapshot-consistency)

Azure 備份也有適用于資料庫工作負載的特製化供應專案，例如工作負載感知的 [SQL Server](backup-azure-sql-database.md) 和 [SAP Hana](sap-hana-db-about.md) 、提供15分鐘的 RPO (復原點目標) ，並允許個別資料庫的備份與還原。

## <a name="backup-process"></a>備份程序

以下是 Azure 備份完成 Azure VM 備份的方式：

1. 針對選取要備份的 Azure Vm，Azure 備份根據您指定的備份排程來啟動備份工作。
1. 在第一次備份期間，如果 VM 正在執行，則會在 VM 上安裝備份擴充功能。
    - 針對 Windows Vm，會安裝 [VMSnapshot 延伸](../virtual-machines/extensions/vmsnapshot-windows.md) 模組。
    - 若是 Linux Vm，則會安裝 [VMSnapshotLinux 延伸](../virtual-machines/extensions/vmsnapshot-linux.md) 模組。
1. 針對正在執行的 Windows Vm，備份會與 Windows 磁碟區陰影複製服務 (VSS) 以取得 VM 的應用程式一致快照集。
    - 依預設，備份會進行完整的 VSS 備份。
    - 如果備份無法建立應用程式一致的快照集，則會取得基礎儲存體 (的檔案一致快照集，因為在 VM 停止) 時，不會進行應用程式寫入。
1. 針對 Linux Vm，備份會採用檔案一致備份。 針對應用程式一致快照集，您需要手動自訂前置/後置腳本。
1. 備份拍攝快照集之後，會將資料傳輸至保存庫。
    - 備份是透過以平行方式備份每個 VM 磁碟來最佳化。
    - 針對每個要備份的磁碟，Azure 備份會讀取磁碟上的區塊，並只識別並傳輸自上次備份之後變更的資料區塊 (差異)。
    - 快照集資料可能不會立即複製到保存庫。 這在尖峰時間可能需耗費數小時。 針對每日備份原則，VM 的總備份時間會小於 24 小時。
1. 啟用 Azure 備份之後對 Windows VM 所做的變更為：
    - Microsoft Visual C++ 2013 可轉散發套件 (x64) -12.0.40660 安裝在 VM 中
    - 磁片區陰影複製服務的啟動類型 (VSS) 變更為自動自手動
    - 已新增 IaaSVmProvider Windows 服務

1. 當資料傳輸完成時，將會移除快照集，並建立復原點。

![Azure 虛擬機器備份架構](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="encryption-of-azure-vm-backups"></a>Azure VM 備份的加密

當您使用 Azure 備份來備份 Azure VM 時，VM 會透過儲存體服務加密 (SSE) 來執行待用加密。 Azure 備份也可以使用 Azure 磁碟加密來備份已加密的 Azure Vm。

**加密** | **詳細資料** | **支援**
--- | --- | ---
**SSE** | 使用 SSE，Azure 儲存體會在儲存資料之前自動將資料加密，以提供待用加密。 Azure 儲存體也會先將資料解密，再加以取出。 Azure 備份支援具有兩種儲存體服務加密類型的 Vm 備份：<li> **具有平臺管理金鑰的 SSE**：此加密預設為 vm 中的所有磁片。 請參閱 [這裡](../virtual-machines/disk-encryption.md#platform-managed-keys)的詳細資訊。<li> **具有客戶管理之金鑰的 SSE**。 使用 CMK，您可以管理用來加密磁片的金鑰。 請參閱 [這裡](../virtual-machines/disk-encryption.md#customer-managed-keys)的詳細資訊。 | Azure 備份使用 SSE 進行 Azure Vm 的待用加密。
**Azure 磁碟加密** | Azure 磁碟加密會加密 Azure Vm 的 OS 和資料磁片。<br/><br/> Azure 磁碟加密與 BitLocker 加密金鑰整合 (Bek) ，這些金鑰會在金鑰保存庫中做為秘密進行保護。 Azure 磁碟加密也會與 (Kek) 的 Azure Key Vault 金鑰加密金鑰整合。 | Azure 備份僅支援備份以 Bek 加密的受控和非受控 Azure Vm，或搭配 Kek 使用 Bek。<br/><br/> Bek 和 Kek 都已備份和加密。<br/><br/> 因為 Kek 和 Bek 已備份，所以具有必要許可權的使用者可以視需要將金鑰和秘密還原回金鑰保存庫。 這些使用者也可以復原已加密的 VM。<br/><br/> 未經授權的使用者或 Azure 無法讀取加密金鑰和秘密。

針對受控和非受控 Azure Vm，備份僅支援使用 Bek 加密的 Vm，或使用 Bek 搭配 Kek 加密的 Vm。

備份的 Bek (秘密) 和 Kek (金鑰) 都會加密。 只有在已授權的使用者將其還原回金鑰保存庫時，才能讀取和使用它們。 未經授權的使用者或 Azure 都無法讀取或使用備份金鑰或秘密。

也會備份 Bek。 因此，如果遺失 Bek，授權的使用者可以將 Bek 還原至金鑰保存庫，並復原已加密的 Vm。 只有具備必要許可權等級的使用者可以備份和還原已加密的 Vm 或金鑰和秘密。

## <a name="snapshot-creation"></a>建立快照集

Azure 備份會根據備份排程來取得快照集。

- **Windows vm：** 針對 Windows Vm，備份服務會與 VSS 協調以取得 VM 磁片的應用程式一致快照集。  根據預設，Azure 備份會進行完整的 VSS 備份 (它會在備份時截斷應用程式的記錄，例如 SQL Server，以取得應用層級一致的備份) 。  如果您使用 Azure VM 備份上的 SQL Server 資料庫，則可以修改此設定，以進行 VSS 複本備份 (以保留記錄) 。 如需詳細資訊，請參閱[這篇文章](./backup-azure-vms-troubleshoot.md#troubleshoot-vm-snapshot-issues)。

- **Linux vm：** 若要取得 Linux Vm 的應用程式一致快照集，請使用 Linux 前置腳本和後置腳本架構來撰寫您自己的自訂腳本，以確保一致性。

  - Azure 備份只會叫用您撰寫的前置/後置腳本。
  - 如果前置腳本和後置腳本執行成功，Azure 備份將復原點標記為應用程式一致。 不過，當您使用自訂腳本時，您最終必須負責應用程式一致性。
  - [深入瞭解](backup-azure-linux-app-consistent.md) 如何設定腳本。

## <a name="snapshot-consistency"></a>快照集一致性

下表說明不同類型的快照集一致性：

**快照式** | **詳細資料** | **復原** | **考量**
--- | --- | --- | ---
**應用程式一致** | 應用程式一致的備份會擷取記憶體內容和擱置 I/O 作業。 應用程式一致快照會使用 VSS 寫入器 (或適用于 Linux) 的前置/後置腳本，以確保在進行備份之前，應用程式資料的一致性。 | 當您使用應用程式一致快照集復原 VM 時，VM 就會開機。 沒有任何資料損毀或遺失。 應用程式會以一致的狀態開始。 | Windows：所有 VSS 寫入器都成功<br/><br/> Linux：預先/後置腳本已設定且成功
**檔案系統一致** | 檔案系統一致備份可同時取得所有檔案的快照集，以提供一致性。<br/><br/> | 當您復原具有檔案系統一致快照集的 VM 時，VM 就會啟動。 沒有任何資料損毀或遺失。 應用程式必須實作自己的「修正」機制，以確保還原的資料一致。 | Windows：某些 VSS 寫入器失敗 <br/><br/> Linux：如果未設定或失敗的前置/後置腳本，預設 () 
**絕對一致** | 當 Azure VM 在備份時關閉時，通常會發生損毀一致的快照集。 只會擷取備份時已存在磁碟上的資料，並加以備份。 | 從 VM 開機程式開始，後面接著磁片檢查以修正損毀錯誤。 在損毀之前未傳送至磁片的任何記憶體內部資料或寫入作業都會遺失。 應用程式會實作本身的資料驗證。 例如，資料庫應用程式可以使用其交易記錄來進行驗證。 如果交易記錄檔中有不在資料庫中的專案，則資料庫軟體會將交易向前復原，直到資料一致為止。 | VM 處於關機狀態 (已停止/解除配置) 狀態。

>[!NOTE]
> 如果布建狀態為 [ **成功**]，Azure 備份會採用檔案系統一致備份。 如果布建狀態為 [無法 **使用** ] 或 [ **失敗**]，則會採用損毀一致的備份。 如果布建狀態為 **建立** 或 **刪除**，這表示 Azure 備份正在重試作業。

## <a name="backup-and-restore-considerations"></a>備份和還原考量

**考量** | **詳細資料**
--- | ---
**磁碟** | VM 磁片的備份是平行的。 例如，如果 VM 有四個磁片，備份服務會嘗試平行備份全部四個磁片。 備份是累進的 (僅備份已變更的資料)。
**排程** |  若要減少備份流量，請在一天中的不同時間備份不同的 Vm，並確定時間不會重迭。 同時間備份多個 VM 會導致流量壅塞。
**準備備份** | 請記住準備備份所需的時間。 準備時間包含安裝或更新備份擴充功能，以及根據備份排程觸發快照。
**資料傳輸** | 請考慮 Azure 備份所需的時間，以識別來自先前備份的增量變更。<br/><br/> 在增量備份中，Azure 備份會藉由計算區塊的總和檢查碼，以判斷有哪些變更。 如果區塊已變更，則會將其標示為傳輸至保存庫。 服務會分析已識別到的區塊，以嘗試進一步減少要傳輸的資料數量。 評估所有已變更的區塊之後，Azure 備份會將變更傳輸至保存庫。<br/><br/> 擷取快照集和將其複製到保存庫之間可能會有延遲。 在尖峰時間，將快照集傳輸至保存庫可能需要最多8小時的時間。 若每日備份，則 VM 的備份時間會小於 24 小時。
**初始備份** | 雖然增量備份的備份時間總計小於 24 小時，但是可能不適合第一次備份。 初始備份所需的時間取決於資料的大小，以及處理備份的時間。
**還原佇列** | Azure 備份會同時處理來自多個儲存體帳戶的還原作業，並將還原要求放入佇列中。
**還原複本** | 進行還原時，資料會從保存庫複製到儲存體帳戶。<br/><br/> 總還原時間取決於每秒的 i/o 作業 (IOPS) 和儲存體帳戶的輸送量。<br/><br/> 若要減少複製時間，請選取未使用其他應用程式寫入或讀取載入的儲存體帳戶。

### <a name="backup-performance"></a>備份效能

這些常見的案例可能會影響備份總時間：

- **將新的磁片新增至受保護的 AZURE VM：** 如果 VM 正在進行增量備份，並新增了新的磁片，則備份時間會增加。 總備份時間可能會持續超過24小時，因為新磁片的初始複寫，以及現有磁片的差異複寫。
- **分割磁片：** 當磁片變更是連續的時，備份作業會更快。 如果變更分散在磁碟中，則備份會必較慢。
- **磁片變換：** 如果正在進行增量備份的受保護磁片有超過 200 GB 的每日變換，則備份可能需要很長的時間 (超過8小時) 才能完成。
- **備份版本：** 最新版本的備份 (稱為「立即還原」版本，) 使用比總和檢查碼比較更優化的進程來識別變更。 但是，如果您使用「立即還原」並已刪除備份快照集，則備份會切換至總和檢查碼比較。 在此情況下，備份作業將會超過24小時 (或) 失敗。

### <a name="restore-performance"></a>還原效能

這些常見的案例可能會影響整個還原時間：

- 總還原時間取決於每秒的輸入/輸出作業 (IOPS) 和儲存體帳戶的輸送量。
- 如果目標儲存體帳戶與其他應用程式讀取和寫入作業一起載入，則總還原時間可能會受到影響。 若要改善還原作業，請選取未與其他應用程式資料一起載入的儲存體帳戶。

## <a name="best-practices"></a>最佳作法

當您設定 VM 備份時，我們建議下列做法：

- 修改原則中設定的預設排程時間。 例如，如果原則中的預設時間是凌晨 12:00，請增加幾分鐘，以最佳化資源的使用。
- 如果您要從單一保存庫還原 Vm，強烈建議您使用不同的 [一般用途 v2 儲存體帳戶](../storage/common/storage-account-upgrade.md) ，以確保目標儲存體帳戶不會受到節流。 例如，每個 VM 都必須有不同的儲存體帳戶。 例如，如果還原10個 Vm，請使用10個不同的儲存體帳戶。
- 針對使用 premium 儲存體搭配立即還原的 Vm 備份，建議您配置 *50%* 的總配置儲存空間的可用空間，而這 **只** 是第一次備份所需的空間。 50% 的可用空間不是第一次備份完成後的備份需求
- 對每一儲存體帳戶的磁碟數目限制，與在基礎結構即服務 (IaaS) VM 上執行的應用程式對磁碟的存取次數多寡有關。 一般做法是，如果單一儲存體帳戶上有 5 到 10 個磁碟或更多磁碟，請將部分磁碟移至個別的儲存體帳戶來平衡負載。
- 若要使用 PowerShell 來還原具有受控磁片的 Vm，請提供額外的參數 **_TargetResourceGroupName_* _ 來指定將還原受控磁片的資源群組，請 [在這裡深入瞭解](./backup-azure-vms-automation.md#restore-managed-disks)。

## <a name="backup-costs"></a>備份成本

使用 Azure 備份所備份的 Azure VM 適用 [Azure 備份定價](https://azure.microsoft.com/pricing/details/backup/)。

在第一次成功備份完成之前，不會開始計費。 儲存體和受保護的 VM 也會在此同時開始計費。 只要 VM 的任何備份資料儲存在保存庫中，就會繼續計費。 如果您停止保護 VM，但 VM 的備份資料仍在保存庫中，則還是會繼續計費。

只有在停止保護且刪除全部備份資料時，才會對指定的虛擬機器停止計費。 當保護停止且沒有任何作用中的備份作業時，最後一個成功 VM 備份的大小會成為每月帳單所使用的受保護執行個體大小。

受保護實例大小的計算是以 VM 的 _actual * 大小為基礎。 VM 的大小是 VM 中所有資料的總和，但不包括暫存儲存體。 定價是根據儲存在資料磁片上的實際資料，而不是每個連接至 VM 的資料磁片所支援的大小上限。

同樣地，備份儲存體帳單是以 Azure 備份中儲存的資料量為基礎，也就是每個復原點中的實際資料總和。

例如，採用 A2 標準大小的 VM，其中具有兩個額外的資料磁片，每個資料磁片的大小上限為 32 TB。 下表顯示每個磁片上儲存的實際資料：

**磁碟** | **大小上限** | **實際儲存的資料**
--- | --- | ---
作業系統磁碟 | 32 TB | 17 GB
本機/暫存磁碟 | 135 GB | 5 GB (未包含備份)
資料磁碟 1 | 32 TB| 30 GB
資料磁碟 2 | 32 TB | 0 GB

在此案例中，VM 的實際容量為 17 GB + 30 GB + 0 GB = 47 GB。 這個受保護的實例大小 (47 GB) 會成為每月帳單的基礎。 當 VM 中的資料量增加時，用於計費變更的受保護實例大小將會相符。

## <a name="next-steps"></a>後續步驟

- [準備進行 AZURE VM 備份](backup-azure-arm-vms-prepare.md)。