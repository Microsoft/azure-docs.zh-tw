---
title: 從 Azure 在內部部署網站中重新保護 VM | Microsoft Docs
description: 將 VM 容錯移轉到 Azure 之後，您可以起始將 VM 容錯回復到內部部署的作業。 了解如何在容錯回復之前重新保護。
services: site-recovery
author: rajani-janaki-ram
manager: gauravd
ms.service: site-recovery
ms.topic: article
ms.date: 07/06/2018
ms.author: rajanaki
ms.openlocfilehash: 1b410b2832d856f80d640aab2096fef270156c81
ms.sourcegitcommit: 30fd606162804fe8ceaccbca057a6d3f8c4dd56d
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/30/2018
ms.locfileid: "39346674"
---
# <a name="reprotect-machines-from-azure-to-an-on-premises-site"></a>從 Azure 在內部部署網站中重新保護機器

將內部部署 VMware VM 或實體伺服器[容錯移轉](site-recovery-failover.md)到 Azure 之後，容錯回復到內部部署網站的第一個步驟，是重新保護在容錯移轉期間建立的 Azure VM。 本文說明如何執行此操作。 

如需快速概觀，請觀看下列有關如何從 Azure 容錯移轉到內部部署網站的影片。<br /><br />
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]


## <a name="before-you-begin"></a>開始之前

如果您使用範本來建立虛擬機器，請確定每部虛擬機器有磁碟本身的 UUID。 如果內部部署虛擬機器和主要目標的 UUID 衝突 (因為兩者都是從相同的範本建立的)，則重新保護會失敗。 部署另一個不是從相同範本建立的主要目標。 請注意下列資訊︰
- 如果您要嘗試容錯回復至替代的 vCenter，請確定您的新 vCenter 和主要目標伺服器均已被探索到。 一般的徵兆是，您在 [重新保護] 對話方塊中無法存取/看到資料存放區。
- 若要複寫回內部部署，您需要容錯回復原則。 當您建立轉送方向原則時，會自動建立此原則。 請注意下列資訊︰
    - 此原則在建立期間會自動與組態伺服器產生關聯。
    - 您無法編輯此原則。
    - 原則的設定值為 (RPO 閾值 = 15 分鐘，復原點保留 = 24 小時，應用程式一致性快照集頻率 = 60 分鐘)。
- 在重新保護和容錯回復期間，內部部署組態伺服器必須執行並連線。
- 如果 vCenter 伺服器管理您要容錯回復的目標虛擬機器，請確定您擁有在 vCenter 伺服器上探索 VM 的[必要權限](vmware-azure-tutorial-prepare-on-premises.md#prepare-an-account-for-automatic-discovery)。
- 在重新保護之前，請刪除主要目標伺服器上的快照集。 如果內部部署的主要目標或虛擬機器上有快照集，重新保護作業將會失敗。 虛擬機器上的快照集會在重新保護作業期間自動合併。
- 複寫群組的所有虛擬機器必須屬於相同的作業系統類型 (全為 Windows 或全為 Linux)。 使用混合作業系統的複寫群組目前不支援重新保護以及容錯回復至內部部署環境。 這是因為主要目標必須屬於與虛擬機器相同的作業系統。 複寫群組的所有虛擬機器必須具有相同的主要目標。 
- 執行容錯回復時，組態伺服器必須為內部部署。 在容錯回復期間，虛擬機器必須存在於組態伺服器資料庫中。 否則，將無法成功容錯回復。 請確實為組態伺服器建立定期排程的備份。 發生災害時，使用相同的 IP 位址還原伺服器，讓容錯回復運作。
- 重新保護和容錯回復都需要站對站 (S2S) VPN 才能複寫資料。 提供網路，讓 Azure 中已容錯移轉的虛擬機器可以觸達 (偵測) 內部部署組態伺服器。 您也可以在容錯移轉虛擬機器的 Azure 網路中部署處理序伺服器。 此處理序伺服器也必須能夠與內部部署組態伺服器進行通訊。
- 請確實開啟下列連接埠以進行容錯移轉和容錯回復：

    ![容錯移轉和容錯回復的端點](./media/vmware-azure-reprotect/failover-failback.png)

- 詳盡閱讀[連接埠和 URL 白名單的先決條件](vmware-azure-deploy-configuration-server.md#prerequisites)。

## <a name="deploy-a-process-server-in-azure"></a>在 Azure 中部署處理序伺服器

在容錯回復到內部部署網站之前，您在 Azure 中可能需要處理序伺服器：
- 處理序伺服器會從在 Azure 中受保護的虛擬機器接收資料，然後將資料傳送至內部部署網站。
- 低延遲網路必須位於處理伺服器與受保護虛擬機器之間。 一般情況下，您需要在決定 Azure 中是否需要處理序伺服器時考慮延遲：
    - 如果您已設定 Azure ExpressRoute 連線，可以使用內部部署處理序伺服器來傳送資料，因為虛擬機器和處理序伺服器之間的延遲很低。
    - 但若您只有 S2S VPN，建議您在 Azure 中部署處理伺服器。
    - 我們建議在容錯回復期間使用 Azure 型處理序伺服器。 如果處理序伺服器比較接近複寫的虛擬機器 (在 Azure 中容錯移轉的機器)，則複寫效能較高。 如需進行概念證明，您可以使用內部部署處理序伺服器與採用私人對等互連的 ExpressRoute。

若要在 Azure 中部署處理序伺服器：

1. 如果您需要在 Azure 中部署處理序伺服器，請參閱[在 Azure 中設定容錯回復的處理序伺服器](vmware-azure-set-up-process-server-azure.md)。
2. Azure VM 會將複寫資料傳送至處理序伺服器。 設定網路，讓 Azure VM 可以連線到處理序伺服器。
3. 請記住，從 Azure 至內部部署的複寫只會透過 S2S VPN 或透過 ExpressRoute 網路的私人對等互連進行。 請確定該網路通道上有足夠的可用頻寬。

## <a name="deploy-a-separate-master-target-server"></a>部署個別的主要目標伺服器

主要目標伺服器會接收容錯回復資料。 根據預設，主要目標伺服器會在內部部署組態伺服器上執行。 不過，您可能必須根據容錯回復流量的大小，另外建立一部用來容錯回復的主要目標伺服器。 以下是建立伺服器的方式：

* [建立 Linux 主要目標伺服器](vmware-azure-install-linux-master-target.md)以便進行 Linux VM 的容錯回復。 這是必填欄位。
* (選擇性) 建立個別的主要目標伺服器以進行 Windows VM 容錯回復。 若要這樣做，請再次執行「整合安裝」，然後選擇建立主要目標伺服器。 [深入了解](site-recovery-plan-capacity-vmware.md#deploy-additional-master-target-servers)。

在建立主要目標伺服器之後，請執行下列工作：

- 如果虛擬機器存在於內部部署的 vCenter 伺服器上，則主要目標伺服器必須能夠存取內部部署虛擬機器的虛擬機器磁碟 (VMDK) 檔案。 有此存取權，才能將複寫的資料寫入至虛擬機器的磁碟。 請確定內部部署內部部署的資料存放區已掛接在主要目標的主機上並已設定讀寫權限。
- 如果虛擬機器不在內部部署的 vCenter 伺服器上，則 Site Recovery 服務必須在重新保護期間建立新的虛擬機器。 您必須在建立主要目標的 ESX 主機上建立此虛擬機器。 請謹慎選擇 ESX 主機，以便在您要的主機上建立容錯回復虛擬機器。
- 您無法對主要目標伺服器使用 Storage vMotion。 對主要目標伺服器使用 Storage vMotion 可能會導致容錯回復失敗。 虛擬機器無法使用磁碟，因此無法啟動。 若要避免發生此問題，請從 vMotion 清單中排除主要目標伺服器。
- 如果主要目標在重新保護後經歷儲存體 vMotion 工作，連結至主要目標的受保護虛擬機器磁碟將會移轉至 vMotion 工作的目標。 如果您嘗試在此之後進行容錯回復，則中斷磁碟連結會由於找不到磁碟而失敗。 後來就很難在您的儲存體帳戶中找到磁碟。 您必須手動找到這些磁碟並附加到虛擬機器之上。 而後，就可以啟動內部部署虛擬機器。
- 將新的磁碟機新增至現有的 Windows 主要目標伺服器。 新增磁碟並格式化磁碟機。 保留磁碟機可用來停止虛擬機器複寫回到內部部署站台時的時間點。 以下是保留磁碟機的一些條件。 若不符合這些條件，將不會列出主要目標伺服器的磁碟機：
    - 磁碟區未另作任何其他用途，例如作為複寫目標。
    - 磁碟區未處於鎖定模式。
    - 磁碟區不是快取磁碟區。 主要目標安裝不可存在於該磁碟區上。 處理序伺服器和主要目標的自訂安裝磁碟區不符合作為保留磁碟區的資格。 當處理序伺服器和主要目標安裝在磁碟區時，磁碟區是主要目標的快取磁碟區。
    - 磁碟區的檔案系統類型不是 FAT 或 FAT32。
    - 磁碟區容量不是零。
    - Windows 的預設保留磁碟區為 R 磁碟區。
    - Linux 的預設保留磁碟區為 /mnt/retention。
- 如果您使用現有的處理序伺服器/組態伺服器機器，或使用調整或處理序伺服器/主要目標伺服器機器，則必須新增磁碟機。 新的磁碟機必須符合前述需求。 如果保留磁碟機不存在，則不會出現在入口網站上的選取下拉式清單中。 將磁碟機新增至內部部署主要目標之後，磁碟機最多需要 15 分鐘才會出現在入口網站上的選取項目中。 如果磁碟機未在 15 分鐘之後出現，您也可以重新整理組態伺服器。
- 在主要目標伺服器上安裝 VMware 工具或 open-vm-tools。 如果沒有工具，就無法偵測主要目標 ESXi 主機上的資料存放區。
- 在 VMware 的主要目標虛擬機器組態參數中，進行 `disk.EnableUUID=true` 設定。 如果此列不存在，請加以新增。 必須進行此設定，才能提供一致的 UUID 給 VMDK，使其可正確掛接。
- 建立主要目標的 ESX 主機至少必須有一個連結的虛擬機器檔案系統 (VMFS) 資料存放區。 若未連結 VMFS 資料存放區，重新保護頁面上的**資料存放區**輸入將會空白，且您將無法繼續操作。
- 主要目標伺服器在磁碟上不可以有快照集。 如果有快照集，重新保護和容錯回復會失敗。
- 主要目標不可以有 Paravirtual SCSI 控制器。 控制器只能是 LSI Logic 控制器。 如果沒有 LSI Logic 控制器，重新保護會失敗。
- 在任何執行個體上，主要目標最多都只能連結 60 個磁碟。 如果要重新保護到內部部署主要目標的虛擬機器數目所擁有的磁碟總數合計超過 60 個，則重新保護到主要目標的作業將會開始失敗。 請確定您有足夠的主要目標磁碟位置，或再額外部署主要目標伺服器。
    

## <a name="enable-reprotection"></a>啟用重新保護

在 Azure 虛擬機器啟動之後，需要經過一些時間，代理程式才會註冊回到組態伺服器中 (最多 15 分鐘)。 在這段時間，您將無法執行重新保護，且會有錯誤訊息指出代理程式未安裝。 如果發生這種情況，請等候幾分鐘，然後再次嘗試重新保護：


1. 選取 [保存庫] > [複寫的項目]。 以滑鼠右鍵按一下已容錯移轉的虛擬機器，然後選取 [重新保護]。 或者，從命令按鈕選取機器，然後選取 [重新保護]。
2. 確認已選取 [Azure 到內部部署] 作為保護方向。
3. 在 [主要目標伺服器] 和 [處理伺服器] 中，選取內部部署主要目標伺服器和處理伺服器。  
4. 對於 [資料存放區]，選取您想要將內部部署磁碟復原至該位置的資料存放區。 當內部部署虛擬機器已被刪除且您需要建立新的磁碟時，請使用此選項。 如果磁碟已存在，則會忽略此選項。 您仍需要指定一個值。
5. 選取保留磁碟機。
6. 系統會自動選取容錯回復原則。
7. 選取 [確定] 以開始重新保護。 隨即開始執行將虛擬機器從 Azure 複寫到內部部署網站的作業。 您可以在 [作業]  索引標籤上追蹤進度。重新保護成功後，虛擬機器會進入受保護狀態。

請注意下列資訊︰
- 如果您想要復原到替代位置 (當內部部署虛擬機器已被刪除時)，請選取為主要目標伺服器所設定的保留磁碟機和資料存放區。 當您容錯回復到內部部署網站時，容錯回復保護計畫中的 VMware 虛擬機器會使用與主要目標伺服器相同的資料存放區。 接著會在 vCenter 中建立新的虛擬機器。
- 若要將 Azure 上的虛擬機器復原到現有的內部部署虛擬機器，請在主要目標伺服器的 ESXi 主機上掛接內部部署虛擬機器的資料存放區並設定讀寫權限。

    ![重新保護對話方塊](./media/vmware-azure-reprotect/reprotectinputs.png)

- 您也可以在復原計劃層級重新保護。 只能透過復原方案重新保護複寫群組。 當您使用復原方案來重新保護時，必須為每個受保護的機器提供值。
- 使用相同的主要目標伺服器來重新保護複寫群組。 如果使用不同的主要目標伺服器重新保護複寫群組，則伺服器無法提供共同的時間點。
- 執行重新保護的期間，內部部署虛擬機器將會關閉。 這有助於確保資料在複寫期間的一致性。 重新保護完成後，請勿開啟虛擬機器。



## <a name="common-issues"></a>常見問題

- 目前，Site Recovery 僅支援容錯回復至 VMFS 或 vSAN 資料存放區。 不支援 NFS 資料存放區。 由於這項限制，重新保護畫面上有關於 NFS 資料存放區的資料存放區選取項目輸入將會是空的，或雖然會顯示 vSAN 資料存放區，但在作業期間卻不會顯示。 如果您想要容錯回復，可建立內部部署的 VMFS 資料存放區，也可容錯回復到 VMFS 資料存放區。 此容錯回復會導致 VMDK 的完整下載。
- 如果您執行唯讀的使用者 vCenter 探索並保護虛擬機器，保護會成功且容錯回復可作用。 在重新保護期間，容錯回復會失敗，因為無法探索資料存放區。 重新保護期間未列出資料存放區是容錯失敗的徵兆。 若要解決此問題，您可以使用具有適當權限的帳戶更新 vCenter 認證，然後重試作業。 
- 當您將 Linux 虛擬機器容錯回復並在內部部署執行它時，您會看到 Network Manager 封裝已從該機器解除安裝。 發生此解除安裝的原因是，在 Azure 中復原虛擬機器時，網路管理員套件已移除。
- 當 Linux 虛擬機器已設定靜態 IP 位址且容錯移轉至 Azure 時，就會從 DHCP 取得 IP 位址。 當您容錯移轉至內部部署時，該虛擬機器會繼續使用 DHCP 取得 IP 位址。 視需要手動登入機器，然後將 IP 位址重新設定為靜態位址。 Windows 虛擬機器可以重新取得其靜態位址 IP。
- 如果您使用 ESXi 5.5 免費版或 vSphere 6 Hypervisor 免費版，則容錯移轉會成功，但容錯回復不會成功。 若要啟用容錯回復，請升級到上述程式的評估授權。
- 若無法從處理伺服器連線至組態伺服器，請使用 Telnet 檢查在連接埠 443 上連至組態伺服器的連線。 您也可以嘗試從處理伺服器 Ping 組態伺服器。 當處理序伺服器已連線至組態伺服器時，應該會有活動訊號。
- 以實體內部部署伺服器的形式受到保護的 Windows Server 2008 R2 SP1 伺服器無法從 Azure 容錯回復至內部部署網站。
- 在下列情況下，您無法容錯回復：
    - 已將機器遷移至 Azure。 [深入了解](migrate-overview.md#what-do-we-mean-by-migration)。
    - 已將 VM 移至另一個資源群組。
    - 已刪除 Azure VM。
    - 已停用 VM 的保護。
    - 已在 Azure 中手動建立 VM。 機器一開始應該在內部部署環境中受到保護，並於容錯移轉至 Azure 後再重新受保護。
    - 您只能容錯回復至 ESXi 主機。 您不能將 VMware VM 或實體伺服器容錯回復至 Hyper-V 主機、實體機器或 VMware 工作站。


## <a name="next-steps"></a>後續步驟

在虛擬機器進入受保護狀態後，您就可以[起始容錯回復](vmware-azure-failback.md)。 容錯回復會關閉 Azure 中的虛擬機器，並啟動內部部署虛擬機器。 預期應用程式停機一段時間。 選擇應用程式允許停機時的容錯回復時間。


