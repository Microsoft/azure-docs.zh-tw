---
title: 保護部署在 Azure Stack 上的 VM | Microsoft Docs
description: 這些指引將說明如何保護部署在 Azure Stack 上的虛擬機器。
services: azure-stack
documentationcenter: ''
author: jeffgilb
manager: femila
editor: ''
ms.assetid: 4e5833cf-4790-4146-82d6-737975fb06ba
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 10/15/2018
ms.author: jeffgilb
ms.reviewer: hector.linares
ms.openlocfilehash: 3c27aecf18fcb5e14347d8f02d71891b351292be
ms.sourcegitcommit: 1aacea6bf8e31128c6d489fa6e614856cf89af19
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/16/2018
ms.locfileid: "49341832"
---
# <a name="protect-virtual-machines-deployed-on-azure-stack"></a>保護部署在 Azure Stack 上的虛擬機器

以本文為指南，計劃如何保護使用者部署在Azure Stack 上的虛擬機器 (VM)。

若要防止資料遺失或意外的停機狀況，您需要為使用者應用程式或其資料實作備份復原或災害復原計劃。 此計劃或許專屬於個別應用程式，但都遵循根據組織完整業務續航力和災害復原 (BC/DR) 策略所建立的架構。 [為 Azure 設計具復原功能的應用程式](https://docs.microsoft.com/azure/architecture/resiliency)是一個好的開始，文中提供應用程式可用性和復原功能的一般模式和做法。

>[!IMPORTANT]
> 持續測試備份還原和災害復原計劃。 您必須這麼做以確保：
> * 計劃有效
> * 計劃依然符合它們原本的設計需求。

## <a name="azure-stack-infrastructure-recovery"></a>Azure Stack 基礎結構復原

使用者負責在 Azure Stack 基礎結構服務中個別保護他們的 VM。

Azure Stack 基礎結構服務的復原計劃**不**包含復原使用者 VM、儲存體帳戶或資料庫。 應用程式擁有者須負責實作應用程式和資料的復原計劃。

如果 Azure Stack 雲端離線時間較長或永久無法復原，您必須有相應的復原計劃，才能：

* 確保最短停機時間
* 讓重要 VM (例如資料庫伺服器) 保持運作
* 讓應用程式持續服務使用者要求

Azure Stack 雲端操作員則負責建立 Azure Stack 基礎結構和服務的復原計劃。 若要深入了解，請參閱[從重大資料遺失的情況下復原](https://docs.microsoft.com/azure/azure-stack/azure-stack-backup-recover-data)。

## <a name="sourcetarget-combinations"></a>來源/目標組合

每個 Azure Stack 雲端都會部署到一個資料中心。 您需要個別的環境，以便復原應用程式。 復原環境可以是不同資料中心內的其他 Azure Stack 雲端，或是 Azure 公用雲端。 您的資料主權和資料隱私權需求會決定應用程式的修復環境。 當您為每個應用程式啟用保護功能時，您可以彈性地為每個應用程式選擇特定的復原選項。 您可以將一個訂用帳戶中的應用程式備份到另一個資料中心。 在另一個訂用帳戶中，您可以將資料複寫至 Azure 公用雲端。

規劃您的備份復原和災害復原策略，以決定每個應用程式的目標。 復原計劃可協助組織適當地調整內部部署所需的儲存體容量大小，以及調整專案在公用雲端中的取用量。

|  | 全域 Azure | Azure Stack 部署在 CSP 資料中心內，且由 CSP 操作 | Azure Stack 部署在客戶資料中心內，且由客戶操作 |
|------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------|
| **Azure Stack 部署在 CSP 資料中心內，且由 CSP 操作** | 使用者 VM 部署在由 CSP 操作的 Azure Stack 中。 使用者 VM 會直接從備份還原至 Azure 或容錯移轉至 Azure。 | CSP 會在自有的資料中心內，操作 Azure Stack 的主要和次要執行個體。 使用者 VM 會在兩個 Azure Stack 執行個體間進行還原或容錯移轉。 | CSP 會在主要站台中操作 Azure Stack。 客戶的資料中心是還原或容錯移轉的目標。 |
| **Azure Stack 部署在客戶資料中心內，且由客戶操作** | 使用者 VM 部署在由客戶操作的 Azure Stack 中。 使用者 VM 會直接從備份還原至 Azure 或容錯移轉至 Azure。 | 客戶會在自有的資料中心內，操作 Azure Stack 的主要和次要執行個體。 使用者 VM 會在兩個 Azure Stack 執行個體間進行還原或容錯移轉。 | 客戶會在主要站台中操作 Azure Stack。 CSP 的資料中心是還原或容錯移轉的目標。 |

![來源-目標組合](media\azure-stack-manage-vm-backup\vm_backupdataflow_01.png)

## <a name="application-recovery-objectives"></a>應用程式復原目標

您必須判斷組織對每個應用程式可容許多少停機時間和資料遺失。 將停機時間和資料遺失量化，您可以建立復原計劃，將對組織造成嚴重損壞的影響降到最低。 針對每個應用程式，請考量：

 - **復原時間目標 (RTO)**  
RTO 是應用程式在事件發生之後可能無法使用的最大可接受時間。 例如，RTO 為 90 分鐘表示必須能夠在災害開始的 90 分鐘內，將應用程式還原為執行狀態。 如果您的 RTO 偏低，就可以讓第二個部署持續以待命狀態執行，從而防止區域性中斷。
 - **復原點目標 (RPO)**  
RPO 是在災害期間可接受的最大資料遺失時間長度。 例如，如果您在單一資料庫中儲存資料，沒有複寫到其他資料庫，且每小時執行備份，可能會遺失最多一個小時的資料。

RTO 和 RPO 是商務需求。 進行風險評量可定義應用程式的 RTO 和 RPO。

另一個計量是**平均復原時間** (MTTR)，這是在失敗後還原應用程式所花費的平均時間。 MTTR 是系統的經驗值。 如果 MTTR 超過 RTO，系統失敗就會導致無法接受的商務中斷，因為將無法在定義的 RTO 內還原系統。

### <a name="backup-restore"></a>備份 - 還原

虛擬機器型應用程式上最常見的保護配置就是使用備份軟體。 備份 VM 通常包含作業系統、作業系統組態、應用程式二進位檔和應用程式資料。 備份是使用磁碟區、磁碟或整個 VM 的快照集所建立的。 透過 Azure Stack，您可以彈性地從客體作業系統的環境中，或從 Azure Stack 儲存體和計算 API 中進行備份。 Azure Stack 不支援使用 Hypervisor 層級上的備份。
 
![備份 - 還原](media\azure-stack-manage-vm-backup\vm_backupdataflow_03.png)

復原應用程式需要將一個或多個 VM 還原至相同雲端或新的雲端。 您可以鎖定您資料中心內的雲端或公用雲端。 您選擇的雲端會完全由您控制，且會以您的資料隱私權和主權需求為基礎。
 
 - RTO：以小時計算的停機時間
 - RPO：變數資料遺失 (視備份頻率而定)
 - 部署拓撲：主動/被動

#### <a name="planning-your-backup-strategy"></a>規劃您的備份策略

從量化需要保護的 VM 執行個體數目開始，規劃您的備份策略及定義規模需求。 備份環境中所有伺服器上的所有 VM 是常見的策略。 不過，若使用 Azure Stack，有一些 VM 則不需要備份。 例如，系統會認為擴展集中的 VM 是來來去去的暫時資源，有時也不會有任何通知。 任何需要保護的永久資料會儲存在個別的存放庫中，例如資料庫或物件儲存區。

在 Azure Stack 上備份 VM 的重要考量：

 - **分類**
    - 請考量使用者為 VM 備份選擇的模型。
    - 根據應用程式優先順序或業務上受到的影響，來定義復原服務等級協定 (SLA)。
 - **調整**
    - 如果有大量新的 VM 正在上架時，請考慮交錯進行備份 (如果有備份需要)。
    - 評估可有效率地擷取並傳輸備份資料的備份產品，以盡可能減少解決方案上的資源內容。
    - 評估可有效率地使用增量或差異備份來儲存備份資料的備份產品，以盡可能減少完整備份環境中所有 VM 的需求。
 - **Restore**
    - 備份產品可還原虛擬磁碟、現有 VM 中的應用程式資料，或整個 VM 資源及相關聯的虛擬磁碟。 您需要的還原配置取決於您打算如何還原應用程式，而這將會影響應用程式的復原時間。 例如，您可以較輕鬆地從範本重新部署 SQL 伺服器，然後再還原資料庫，而不是還原整個 VM 或一組 VM。

### <a name="replicationmanual-failover"></a>複寫/手動容錯移轉

支援高可用性的替代方法是將您的應用程式 VM 複寫到另一個雲端，並依賴手動容錯移轉。 您可以在 VM 層級或客體作業系統層級執行作業系統、應用程式二進位檔及應用程式資料的複寫。 使用獨立於應用程式的其他軟體來管理容錯移轉。

透過這個方法，應用程式會部署在某個雲端中，它的 VM 則會複寫到另一個雲端。 如果觸發了容錯移轉，次要 VM 就必須在第二個雲端中開啟。 在某些情況下，容錯移轉會建立 VM，並將磁碟連結到 VM。 此程序可能會需要長時間來完成，特別是需要特定啟動順序的多層式應用程式。 在應用程式準備好開始處理要求之前，可能也會有必須先執行的步驟。

![複寫 - 手動容錯移轉](media\azure-stack-manage-vm-backup\vm_backupdataflow_02.png)

 - RTO：以分鐘計算的停機時間
 - RPO：變數資料遺失 (視複寫頻率而定)
 - 部署拓撲：主動/被動待命
 
### <a name="high-availabilityautomatic-failover"></a>高可用性/自動容錯移轉

如果企業對應用程式的容許程度是幾秒或幾分鐘的停機時間和最少的資料遺失量，那麼您必須考慮高可用性組態。 高可用性應用程式旨在快速且自動地從錯誤中復原。 針對本機硬體錯誤，Azure Stack 基礎結構會使用兩個機架頂端的交換器，在實體網路中實作高可用性。 針對計算層級錯誤，Azure Stack 會在縮放單位中使用多個節點。 在 VM 層級中，您可以結合使用擴展集和容錯網域，以確保節點失敗不會影響您的應用程式。

若結合擴展集，您的應用程式將必須以原生方式支援高可用性，或支援使用叢集軟體。 例如，Microsoft SQL Server 會使用同步認可模式，以原生方式支援資料庫的高可用性。 不過，如果您只可支援非同步複寫，則會有部分資料遺失。 應用程式也可以部署到容錯移轉叢集中，其中叢集軟體會處理應用程式的自動容錯移轉。

如果使用這個方法，應用程式只會在一個雲端中運作，但軟體會部署至多個雲端。 其他雲端處於待命模式，當容錯移轉觸發時，即可啟動啟動應用程式。

 - RTO：以秒計算的停機時間
 - RPO：最少的資料遺失量
 - 部署拓撲：主動/主動待命

### <a name="fault-tolerance"></a>容錯

Azure Stack 的實體備援和基礎結構服務可用性，只能針對硬體層級的失敗/失效提供保護，例如磁碟、電源供應、網路連接埠或節點。 不過，如果您的應用程式必須一直保持可用狀態，且不能遺失任何資料，那麼您必須在應用程式中以原生方式實作容錯功能，或使用其他軟體來啟用容錯功能。

首先，您需要先確定應用程式 VM 是使用擴展集部署的，才能對節點層級的失敗進行防護。 若要對雲端離線的狀況有所防護，則必須將相同的應用程式部署至不同雲端，讓其可以不中斷地繼續處理要求。 這個模型通常稱為「主動-主動」部署。

請記住，每個 Azure Stack 雲端皆彼此獨立，因此從基礎結構的角度來看，雲端一律是作用中的狀態。 在此情況下，應用程式的多個作用中執行個體會部署至一個或多個作用中的雲端。

 - RTO：沒有停機時間
 - RPO：沒有資料遺失
 - 部署拓撲：主動/主動

### <a name="no-recovery"></a>沒有復原功能

在您的環境中，某些應用程式可能不需要對意外的停機或資料遺失有所防護。 例如，用於開發和測試的 VM 通常不需要進行復原。 您可以決定不對應用程式或特定 VM 進行保護。 Azure Stack 不會從基礎結構提供 VM 的備份或複寫。 與 Azure 類似，您必須為每個訂用帳戶中的每個 VM 選擇保護功能。

 - RTO：無法復原
 - RPO：資料完全遺失

## <a name="recommended-topologies"></a>建議的拓撲

Azure Stack 部署的的重要考量：

|     | 建議 | 註解 |
|-------------------------------------------------------------------------------------------------|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 將 VM 備份/還原至已部署在您資料中心的外部備份目標 | 建議 | 充分利用現有備份基礎結構和操作技術。 務必調整備份基礎結構的大小，讓其可以保護額外的 VM 執行個體。 請確定備份基礎結構不是非常接近您的來源。 您可以將 VM 還原到來源 Azure Stack、次要 Azure Stack 執行個體等。 |
| 將 VM 備份/還原至 Azure Stack 專屬的外部備份目標 | 建議 | 您可以購買新的備份基礎結構或佈建 Azure Stack 專用的備份基礎結構。 請確定備份基礎結構不是非常接近您的來源。 您可以將 VM 還原到來源 Azure Stack、次要 Azure Stack 執行個體等。 |
| 直接將 VM 備份/還原至全域 Azure 或受信任的服務提供者 | 建議 | 只要能符合您的資料隱私權和法規要求，您可以將備份儲存在全域 Azure 或受信任的服務提供者中。 最理想的情況是服務提供者也執行 Azure Stack，如此一來，你在還原時就有一致的操作體驗。 |
| 將 VM 複寫/容錯移轉至個別的 Azure Stack 執行個體 | 建議 | 在容錯移轉的案例中，您必須有第二個可完全正常運作的 Azure Stack 雲端，讓您避免更長的應用程式停機時間。 |
| 直接將 VM 複寫/容錯移轉至 Azure 或受信任的服務提供者 | 建議 | 只要能符合您的資料隱私權和法規要求，您可以將資料複寫至全域 Azure 或受信任的服務提供者中。 最理想的情況是服務提供者也執行 Azure Stack，如此一來，你在容錯移轉後就有一致的操作體驗。 |
| 使用應用程式資料部署同個 Azure Stack 雲端上的備份目標 | 不建議使用 | 請避免將備份儲存在相同的 Azure Stack 雲端中。 雲端中意外的停機時間，可能會讓您無法使用主要資料和備份資料。 如果您選擇將備份目標部署為虛擬設備 (為達到最佳化的備份和還原)，您必須確定所有資料會持續複製到外部的備份位置。 |
| 將實體備份設備部署至安裝 Azure Stack 方案所在的相同機架 | 不支援 | 目前，您無法將任何其他裝置連線到機架頂端的交換器，這不屬於原始方案的一部份。 |

## <a name="next-steps"></a>後續步驟

本文提供一般指引，說明如何保護部署在 Azure Stack 上的使用者 VM。 如需有關如何使用 Azure 服務保護使用者 VM 的詳細資訊，請參閱：

 - [使用 Azure 備份來備份 Azure Stack 上的檔案和應用程式](https://docs.microsoft.com/azure/backup/backup-mabs-files-applications-azure-stack)
 - [Azure Stack 的 Azure 備份伺服器支援](https://docs.microsoft.com/azure/backup/ ) 
 - [Azure Stack 的 Azure Site Recovery 支援](https://docs.microsoft.com/azure/site-recovery/)  

若要深入了解 Azure Stack 上可提供 VM 保護的合作夥伴產品，請參閱「[在 Azure Stack 上保護應用程式與資料](https://azure.microsoft.com/blog/protecting-applications-and-data-on-azure-stack/)」。
