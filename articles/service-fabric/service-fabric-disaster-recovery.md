---
title: Azure Service Fabric 嚴重損壞修復
description: Azure Service Fabric 提供處理災難的功能。 本文說明可能會發生的災害類型以及如何加以處理。
author: masnider
ms.topic: conceptual
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 8d99b4d1fbf227d850de387b7ca24dcd3fd40646
ms.sourcegitcommit: a055089dd6195fde2555b27a84ae052b668a18c7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/26/2021
ms.locfileid: "98791150"
---
# <a name="disaster-recovery-in-azure-service-fabric"></a>Azure Service Fabric 中的災害復原
提供高可用性的重要部分是確保服務可以存留于所有不同類型的失敗。 這對未規劃且不在您的控制範圍外的失敗特別重要。 

本文說明一些常見的失敗模式，如果未正確建立模型和管理，可能會造成嚴重損壞。 它也會討論在發生嚴重損壞時要採取的緩和措施和動作。 目標是要在發生失敗、已規劃或其他情況時，限制或消除停機或資料遺失的風險。

## <a name="avoiding-disaster"></a>避免災害
Azure Service Fabric 的主要目標是協助您以一般失敗類型不會造成嚴重損壞的方式，為您的環境和服務建立模型。 

一般情況下，有兩種類型的嚴重損壞/失敗案例：
- 硬體和軟體錯誤
- 操作錯誤

### <a name="hardware-and-software-faults"></a>硬體和軟體錯誤
硬體和軟體錯誤是無法預期的。 存活錯誤最簡單的方式是跨硬體或軟體容錯界限執行更多的服務複本。 

例如，如果您的服務只在一部電腦上執行，則該一部機器的失敗會是該服務的嚴重損壞。 避免這種嚴重損壞的簡單方法，是確定服務正在多部電腦上執行。 您也必須進行測試，以確保一部電腦的失敗不會中斷執行中的服務。 容量規劃可確保您可以在其他地方建立取代實例，而且容量縮減不會多載其餘的服務。 

無論您想避免的故障類型為何，相同的模式皆可發揮作用。 比方說，如果您擔心 SAN 失敗，就會跨多個 San 執行。 如果您擔心伺服器機架損失，可跨多個機架執行。 如果您擔心資料中心遺失，您的服務應該跨多個 Azure 區域、跨多個 Azure 可用性區域，或在您自己的資料中心執行。 

當服務跨越多個實體實例時 (電腦、機架、資料中心、區域) ，您仍會受到某些類型的同時失敗的影響。 但是，特定類型的單一和甚至多個失敗 (例如，單一虛擬機器或失敗) 的網路連結會自動處理，因此不再是「災難」。 

Service Fabric 提供了擴充叢集的機制，以及處理失敗的節點和服務的處理。 Service Fabric 也可讓您執行多個服務實例，以防止未計畫的失敗變成真正的災難。

有可能是因為執行的部署夠大而無法跨越失敗的原因。 例如，它可能會比您願意支付更多硬體資源的費用，而不是相對於失敗的機率。 當您處理分散式應用程式時，跨地理位置的額外通訊躍點或狀態複寫成本可能會導致無法接受的延遲。 每個應用程式繪製的此線條有所不同。 

特別針對軟體錯誤，錯誤可能在您嘗試調整的服務中。 在此情況下，較多的複本並不會造成嚴重損壞，因為失敗狀況會在所有實例之間相互關聯。

### <a name="operational-faults"></a>操作錯誤
即使您的服務遍布全球，具備許多備援，仍可能會遇到災難性的事件。 例如，有人可能不小心重新設定服務的 DNS 名稱，或直接將它刪除。 

舉例來說，假設您的 Service Fabric 具狀態服務，而有人不小心刪除了該服務。 除非有其他緩和措施，否則該服務及其擁有的所有狀態現在都已消失。 這些類型的操作災害 (「糟糕」情況) 恢復所需的緩解和步驟與一般未預期故障不同。 

避免這類操作錯誤的最佳方式是：
- 限制對環境的操作存取。
- 嚴格地審核危險的作業。
- 強制執行自動化、避免手動或頻外變更，並且在制定這些變更之前，先對環境驗證其特定變更。
- 確定破壞性作業是「軟的」。 軟體的作業不會立即生效，也不會在某個時間範圍內復原。

Service Fabric 提供防止操作錯誤的機制，例如提供叢集作業的 [角色型](service-fabric-cluster-security-roles.md) 存取控制。 不過，大部分的操作錯誤需要投入組織化的心力以及其他系統。 Service Fabric 提供了存活運作錯誤的機制，最值得注意的是可設定 [狀態服務的備份和還原](service-fabric-backuprestoreservice-quickstart-azurecluster.md)。

## <a name="managing-failures"></a>管理故障
Service Fabric 的目標是自動管理失敗。 但為了處理某些類型的失敗，服務必須有額外的程式碼。 基於安全和商務持續性的理由， _不_ 應該自動解決其他類型的失敗。 

### <a name="handling-single-failures"></a>處理單一故障
單一機器可能鑒於各種原因而故障。 有時它是硬體的原因，像是電源供應器和網路硬體失敗。 其他是軟體故障， 這些包括作業系統和服務本身的失敗。 Service Fabric 會自動偵測這些類型的失敗，包括機器因為網路問題而與其他電腦隔離的情況。

無論服務類型為何，如果程式碼的單一複本因故失敗，執行單一執行個體會造成該服務停機。 

若要處理任何單一失敗，最簡單的方式是確保您的服務預設會在一個以上的節點上執行。 針對無狀態服務，請確定 `InstanceCount` 大於1。 對於具狀態服務，最小的建議是， `TargetReplicaSetSize` 而且 `MinReplicaSetSize` 都設為3。 執行服務程式碼的多個複本可確保您的服務可自動處理任何單一失敗。 

### <a name="handling-coordinated-failures"></a>處理協調失敗
叢集中的協調失敗可能是因為計畫或未規劃的基礎結構失敗、變更或計畫的軟體變更所致。 Service Fabric 將遇到協調失敗的基礎結構區域模型視為 *容錯網域*。 將會遇到協調軟體變更的區域會以 *升級網域* 的形式進行模型化。 如需有關容錯網域、升級網域和叢集拓撲的詳細資訊，請參閱 [使用叢集資源管理員描述 Service Fabric](service-fabric-cluster-resource-manager-cluster-description.md)叢集。

根據預設，Service Fabric 會在規劃服務的執行位置時考慮容錯和升級網域。 根據預設，Service Fabric 會嘗試確保您的服務會在多個容錯網域和升級網域中執行，以便在發生規劃或未規劃的變更時，您的服務仍可供使用。 

例如，假設電源失敗會導致機架上的所有機器都同時故障。 當服務的多個複本執行時，容錯網域失敗中的許多機器都會變成單一失敗的另一個範例。 這就是為什麼管理容錯和升級網域對於確保服務的高可用性相當重要。 

當您在 Azure 中執行 Service Fabric 時，系統會自動管理容錯網域和升級網域。 在其他環境中，它們可能不是。 如果您要在內部部署環境中建立自己的叢集，請務必正確地對應並規劃您的容錯網域版面配置。

升級網域適用于將同時升級軟體的模型化區域。 基於這個原因，升級網域通常也會定義在規劃的升級期間，軟體會被關閉的界限。 Service Fabric 和您的服務升級皆遵循相同的模型。 如需輪流升級、升級網域以及 Service Fabric 健全狀況模型的詳細資訊，以協助防止非預期的變更影響叢集和您的服務，請參閱：

 - [應用程式升級](service-fabric-application-upgrade.md)
 - [應用程式升級教學課程](service-fabric-application-upgrade-tutorial.md)
 - [Service Fabric 健全狀況模型](service-fabric-health-introduction.md)

您可以使用 [Service Fabric Explorer](service-fabric-visualizing-your-cluster.md)中提供的叢集對應，將叢集的版面配置視覺化：

<center>

![分散到 Service Fabric Explorer 之容錯網域的節點][sfx-cluster-map]
</center>

> [!NOTE]
> 模型化失敗、輪流升級、執行服務程式代碼和狀態的許多實例、放置規則，以確保您的服務在容錯和升級網域中執行，而內建的健康情況監視只是 Service Fabric 提供的 *一些* 功能，可讓正常操作問題和失敗變成災難。 
>

### <a name="handling-simultaneous-hardware-or-software-failures"></a>處理同時發生的硬體或軟體故障
我們已討論過單一失敗。 如您所見，只要在容錯網域和升級網域中保存更多的程式碼 (和狀態) ，就可以輕鬆地處理無狀態和具狀態服務。 

也可能發生多個同時的隨機失敗。 這些可能會導致停機或實際的災難。


#### <a name="stateless-services"></a>無狀態服務
無狀態服務的實例計數表示需要執行的實例數目。 當實例的任何 (或所有) 都失敗時，Service Fabric 會藉由在其他節點上自動建立取代實例來回應。 Service Fabric 會繼續建立取代，直到服務回到其所需的實例計數。

例如，假設無狀態服務的 `InstanceCount` 值為-1。 此值表示一個實例應該在叢集中的每個節點上執行。 如果其中某些實例失敗，Service Fabric 將會偵測到服務不是處於預期的狀態，而且會嘗試在遺漏節點的節點上建立實例。

#### <a name="stateful-services"></a>具狀態服務
具狀態服務有兩種類型：
- 具有保存狀態的具狀態。
- 具有非保存狀態的具狀態。  (狀態儲存在記憶體中。 ) 

從具狀態服務的失敗復原取決於具狀態服務的類型、服務擁有多少個複本，以及有多少個複本失敗。

在具狀態服務中，會在 (主要和任何作用中次要) 的複本之間複寫內送資料。 如果大部分的複本都會收到資料，則會將資料視為認可 *仲裁* 。  (五個複本，三個將會是仲裁。 ) 這表示在任何時間點，至少會有具有最新資料的複本仲裁。 如果複本失敗 (假設有兩個) ，我們可以使用仲裁值來計算是否可以復原。  (，因為剩下的三個複本仍在執行中，所以保證至少有一個複本會有完整的資料。 ) 

當複本的仲裁失敗時，資料分割會宣告為處於 *仲裁遺失* 狀態。 假設分割區有五個複本，這表示至少有三個複本保證具有完整的資料。 如果仲裁 (三個複本的三個) 都失敗，Service Fabric 無法判斷剩餘的複本 (兩個以上的) 有足夠的資料來還原資料分割。 在 Service Fabric 偵測到仲裁遺失的情況下，其預設行為是防止對分割區進行額外寫入、宣告仲裁遺失，並等候複本的仲裁還原。

判斷具狀態服務是否發生嚴重損壞，然後進行管理時，會遵循三個階段：

1. 判斷是否有仲裁遺失。
   
   當具狀態服務的大部分複本同時關閉時，就會宣告仲裁遺失。
2. 判斷仲裁遺失是否為永久的。
   
   大多數時候，失敗是暫時性的。 系統會重新開機進程、重新開機節點、relaunched 虛擬機器，以及修復網路磁碟分割。 不過，有時失敗是永久性的。 失敗是永久性的，還是不會取決於具狀態服務是否會保存其狀態，或是否只將它保留在記憶體中： 
   
   - 對於非持續狀態的服務，單一仲裁或多個複本的失敗會 _立即_ 導致永久性的仲裁遺失。 當 Service Fabric 偵測到具狀態非持續服務中的仲裁遺失時，會藉由宣告 (可能) 資料遺失，立即進行步驟 3。 繼續進行資料遺失有意義，因為 Service Fabric 知道沒有任何時間點等候複本回來。 即使它們復原，資料仍會因為服務的非保存性質而遺失。
   - 對於具狀態的持續性服務，仲裁或更多複本的失敗會導致 Service Fabric 等候複本返回，並還原仲裁。 這會導致任何 _寫入_ 服務的受影響分割區 (複本集) 發生服務中斷。 不過，使用較低的一致性保證仍然可能發生讀取。 Service Fabric 等候仲裁還原的預設時間量是 *無限* 的，因為繼續是 (可能) 資料遺失事件，並且會帶來其他風險。 這表示除非系統管理員採取動作來宣告資料遺失，否則 Service Fabric 不會繼續進行下一個步驟。
3. 判斷資料是否遺失，並從備份還原。

   如果已將仲裁遺失 (自動或透過系統管理動作宣告) ，Service Fabric 和服務會繼續進行，以判斷資料是否真的遺失。 此時，Service Fabric 也知道其他複本不會回來。 這是停止等待自行解決仲裁遺失時會作出的決定。 服務採用的最佳方法通常是凍結，並等待特定的管理介入處理。
   
   當 Service Fabric 呼叫 `OnDataLossAsync` 方法時，一律是因為 _可疑_ 的資料遺失。 Service Fabric 可確保此呼叫會傳遞至 _最佳_ 剩餘複本。 這是進度最多的複本。 
   
   我們一律會指出 _可疑_ 資料遺失的原因是，其餘複本的狀態可能與當仲裁遺失時的主要複本相同。 不過，如果沒有與其相比的狀態，Service Fabric 或運算子確實沒有好方法可用。     
   
   那麼，`OnDataLossAsync` 方法的典型做法是什麼？
   1. 已觸發的執行記錄 `OnDataLossAsync` ，並會引發任何必要的系統管理警示。
   1. 通常，執行會暫停並等候進一步的決策，以及採取手動動作。 這是因為即使備份可供使用，也可能需要做好準備。 
   
      例如，如果有兩個不同的服務協調資訊，可能需要修改這些備份，以確保在進行還原之後，這兩個服務所關心的資訊是一致的。 
   1. 服務通常會有一些其他遙測或耗盡。 此中繼資料可能包含在其他服務或記錄檔中。 您可以視需要使用這項資訊，判斷在主要複本上是否有任何在備份中未出現的呼叫，或複寫到這個特定複本的呼叫。 這些呼叫可能需要重新執行或新增至備份，才能進行還原。  
   1. 此實作為將其餘複本的狀態與任何可用備份中包含的狀態進行比較。 如果您使用 Service Fabric 可靠的集合，則有可用的 [工具和](service-fabric-reliable-services-backup-restore.md) 程式。 目標是要查看複本中的狀態是否足夠，以及查看可能遺失的備份。
   1. 完成比較之後，以及在完成還原之後 () 必要時，如果已進行任何狀態變更，則服務程式代碼應傳回 **true** 。 如果複本判斷它是最適合的狀態複本，而且沒有進行任何變更，則程式碼會傳回 **false**。 
   
      值為 **true** 時，表示任何 _其他_ 剩餘的複本現在可能不一致。 將會卸除這些複本，並從此複本重建。 值為 **false** 表示未進行任何狀態變更，因此其他複本可以保留其所擁有的內容。 

在生產環境中部署服務之前，服務作者必須先實務潛在的資料遺失和失敗案例。 為了防止資料遺失的可能性，請務必定期將任何具狀態服務 [的狀態備份](service-fabric-reliable-services-backup-restore.md) 到異地冗余存放區。 

您也必須確定您能夠還原狀態。 因為許多不同服務的備份會在不同的時間執行，所以您必須確保在還原之後，您的服務會有彼此一致的觀點。 

例如，假設有一個服務產生數位並加以儲存，然後將它傳送至另一個也儲存它的服務。 在還原之後，您可能會發現第二個服務具有數位，但第一個服務沒有數位，因為它的備份未包含該操作。

如果您發現剩餘複本不足以在資料遺失案例中繼續進行，而且您無法從遙測或耗盡中重建服務狀態，則備份的頻率將決定您的最佳復原點目標 (RPO) 。 Service Fabric 提供許多工具來測試各種失敗情況，包括需要從備份還原的永久仲裁和資料遺失。 這些案例是由錯誤分析服務所管理 Service Fabric 中的可測試性工具所包含的一部分。 如需這些工具和模式的詳細資訊，請參閱 [錯誤分析服務簡介](service-fabric-testability-overview.md)。 

> [!NOTE]
> 系統服務也可能會受到仲裁遺失的影響。 影響是針對有問題的服務所造成。 比方說，命名服務中的仲裁遺失會影響名稱解析，而容錯移轉管理員服務中的仲裁遺失會封鎖新的服務建立與容錯移轉。 
> 
> Service Fabric 系統服務遵循與您的服務進行狀態管理相同的模式，但我們不建議您嘗試將它們移出仲裁遺失，並進入潛在的資料遺失。 相反地，我們建議您  [尋求支援](service-fabric-support.md) ，以找出以您的情況為目標的解決方案。 通常最好是等到關閉的複本恢復為止。
>

#### <a name="troubleshooting-quorum-loss"></a>針對仲裁遺失進行疑難排解

複本可能因為暫時性失敗而間歇性關機。 等候一段時間，Service Fabric 嘗試使其啟動。 如果複本已關閉超過預期的持續時間，請遵循下列疑難排解動作：
- 複本可能會損毀。 檢查複本層級的健康情況報告和您的應用程式記錄。 收集損毀傾印，並採取必要動作來復原。
- 複本進程可能會變成沒有回應。 檢查您的應用程式記錄檔以確認此情況。 收集進程傾印，然後停止沒有回應的進程。 Service Fabric 將會建立取代程式，並嘗試將複本帶回來。
- 裝載複本的節點可能已關閉。 重新開機基礎虛擬機器以使節點啟動。

有時候，可能無法復原複本。 例如，磁片磁碟機失敗，或電腦實際沒有回應。 在這些情況下，Service Fabric 必須被告知不要等待複本復原。

如果 *無法* 接受可能的資料遺失，使服務上線，請勿使用這些方法。 在這種情況下，所有工作都應該進行復原實體機器。

下列動作可能會導致資料遺失。 請先進行檢查，再繼續進行。
   
> [!NOTE]
> 針對特定的資料分割，使用這些方法並不是以目標方式來使用， _絕對不_ 安全。 
>

- 使用 `Repair-ServiceFabricPartition -PartitionId` 或 `System.Fabric.FabricClient.ClusterManagementClient.RecoverPartitionAsync(Guid partitionId)` API。 此 API 可讓您指定資料分割的識別碼，以移出仲裁遺失並進入潛在的資料遺失。
- 如果您的叢集遇到導致服務進入仲裁遺失狀態，而且可能會 _遺失資料_ 的頻繁失敗，則指定適當的 [QuorumLossWaitDuration](/powershell/module/servicefabric/update-servicefabricservice) 值可以協助您的服務自動復原。 Service Fabric 會等待提供的 `QuorumLossWaitDuration` 值 (預設為無限) ，再執行復原。 我們 *不* 建議這種方法，因為這可能會導致非預期的資料遺失。

## <a name="availability-of-the-service-fabric-cluster"></a>Service Fabric 叢集的可用性
一般來說，Service Fabric 叢集是高度分散的環境，不會有單一失敗點。 任何一個節點的失敗都不會造成叢集的可用性或可靠性問題，主要是因為 Service Fabric 系統服務遵循先前提供的相同指導方針。 也就是說，它們預設一律會以三個或更多個複本執行，而且在所有節點上都執行無狀態的系統服務。 

基礎 Service Fabric 網路服務與失敗偵測層會完全分散。 大部分的系統服務可從叢集中的中繼資料重建，或了解如何從其他地方重新同步處理其狀態。 如果系統服務進入仲裁遺失的情況（如先前所述），則叢集的可用性可能會受到危害。 在這些情況下，您可能無法在叢集上執行某些作業 (例如啟動升級或部署新的服務) ，但叢集本身仍在運作中。 

執行中叢集上的服務會繼續執行這些條件，除非它們需要寫入系統服務才能繼續運作。 例如，如果容錯移轉管理員處於仲裁遺失，則所有服務都將繼續執行。 但是任何失敗的服務都將無法自動重新開機，因為這需要容錯移轉管理員的介入。 

### <a name="failures-of-a-datacenter-or-an-azure-region"></a>資料中心或 Azure 區域的失敗
在罕見的情況下，實體資料中心可能會因為斷電或網路連線而暫時無法使用。 在這些情況下，在資料中心或 Azure 區域中的 Service Fabric 叢集和服務將無法使用。 不過，_您的資料會保留下來_。 

對於在 Azure 中執行的叢集，您可以在 [Azure 狀態頁面][azure-status-dashboard]上檢視中斷的更新。 在不太可能的情況下，實體資料中心是部分或完全終結的，任何裝載于該處的 Service Fabric 叢集或它們內的服務，都可能會遺失。 這種遺失包括在該資料中心或區域以外未備份的任何狀態。

有兩個不同的策略可存活單一資料中心或區域的永久或持續性失敗： 

- 在多個這類區域中執行不同的 Service Fabric 叢集，並在這些環境之間使用某些機制來進行容錯移轉和容錯回復。 這類多叢集主動/主動或主動/被動模型需要額外的管理和操作程式碼。 此模型也需要協調某個資料中心或區域中服務的備份，如此一來，當資料中心或區域發生失敗時，它們就可以在其他資料中心或區域中使用。 
- 執行跨越多個資料中心或區域的單一 Service Fabric 叢集。 此策略的最低支援設定是三個資料中心或區域。 建議的區域或資料中心數目為五個。 
  
  此模型需要更複雜的叢集拓撲。 不過，其優點是某個資料中心或區域的失敗從嚴重損壞轉換為正常失敗。 可藉由在單一區域內為叢集運作的機制來處理這些失敗。 「容錯網域」、「升級網域」和 Service Fabric 放置規則，可確保將工作負載散發，使其可容忍正常失敗。 
  
  如需可協助您在這種類型的叢集中操作服務之原則的詳細資訊，請參閱 [Service Fabric 服務的放置原則](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md)。

### <a name="random-failures-that-lead-to-cluster-failures"></a>導致叢集失敗的隨機失敗
Service Fabric 具有 *種子節點* 的概念。 種子節點是維護基礎叢集可用性的節點。 

種子節點可協助確保叢集藉由在其他節點上建立租用，並在特定失敗類型中做為決勝局。 如果隨機失敗會移除叢集中大部分的種子節點，而且它們不會快速恢復，您的叢集就會自動關機。 叢集接著會失敗。 

在 Azure 中，Service Fabric 資源提供者會管理 Service Fabric 叢集設定。 根據預設，資源提供者會在 *主要節點類型* 的容錯網域和升級網域之間散發種子節點。 如果主要節點類型標示為銀級或金級持久性，則當您在主要節點類型中進行調整，或藉由手動將其移除) 來移除種子節點 (時，叢集會嘗試從主要節點類型的可用容量中升級另一個非種子節點。 如果您的容量低於您的主要節點類型所需的叢集可靠性層級，此嘗試將會失敗。

在獨立 Service Fabric 叢集和 Azure 中，主要節點類型是執行種子的節點類型。 當您定義主要節點類型時，Service Fabric 會自動利用所提供的節點數目，其方式是建立最多9個種子節點和每個系統服務的七個複本。 如果一組隨機失敗同時接管大部分的複本，則系統服務會進入仲裁遺失。 如果大多數種子節點遺失，叢集將在不久後關閉。

## <a name="next-steps"></a>後續步驟
- 瞭解如何使用可 [測試性架構](service-fabric-testability-overview.md)來模擬各種失敗。
- 閱讀其他災害復原和高可用性的資源。 Microsoft 已發佈大量有關這些主題的指引。 雖然其中有些資源是指在其他產品中使用的特定技術，但它們包含許多可在 Service Fabric 內容中套用的一般最佳作法：
  - [可用性檢查清單](/azure/architecture/checklist/resiliency-per-service)
  - [執行災害復原演練](../azure-sql/database/disaster-recovery-drills.md)
  - [Azure 應用程式的災害復原和高可用性][dr-ha-guide]
- 了解 [Service Fabric 支援選項](service-fabric-support.md)。


<!-- External links -->

[repair-partition-ps]: /windows/win32/perfctrs/specifying-a-counter-path
[azure-status-dashboard]:https://azure.microsoft.com/status/
[azure-regions]: https://azure.microsoft.com/regions/
[dr-ha-guide]: /previous-versions/azure/dn251004(v=azure.100)


<!-- Images -->

[sfx-cluster-map]: ./media/service-fabric-disaster-recovery/sfx-clustermap.png
